{% extends "common_dashboard.j2" %}
{% set refresh_seconds = 300 %}

{% block title %}Local Branch Info{% endblock %}
{% block favicon %}<link rel="icon" type="image/svg+xml" href="favicon.svg">{% endblock %}

{% block css %}
    .header a { color: #ffffff; text-decoration: none; }
    .header a:hover { text-decoration: underline; }
    .timestamp { margin: 5px 0 0 0; opacity: 0.9; font-size: 12px; }
    pre {
      background-color: #ffffff;
      border: 1px solid #d0d7de;
      border-radius: 4px;
      padding: 12px;
      /* Avoid nested scrollbars when expanding triangles; let the page scroll instead. */
      overflow: visible;
      /* Wrap long lines so we don't introduce horizontal scrollbars on expansion. */
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 13px;
      line-height: 1;
      margin: 0;
    }
    a { color: #0969da; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .repo-name { font-weight: bold; margin-top: 10px; }
    .current { font-weight: bold; }
    .merged-branch { color: #999999; }
    .indent { margin-left: 20px; }
    .error { color: #c83a3a; }

    /* Status indicator pill (same look as show_commit_history.j2) */
    .status-indicator {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      margin-right: 6px;
      vertical-align: middle;
      font-size: 10px;
      font-weight: 600;
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border: 1px solid transparent;
    }
    .status-success { background-color: #2da44e; border-color: #1f7a37; }
    .status-failed { background-color: #c83a3a; border-color: #a83232; }
    .status-warning { background-color: #8c959f; border-color: #6e7781; }
    .status-building { background-color: #8c959f; border-color: #6e7781; }
    .status-unknown { background-color: #8c959f; border-color: #6e7781; }
{% endblock %}

{# Error snippet toggle JS is shared in common_dashboard.j2 #}

{% block header_title %}
<span>Local Branch Info</span>
<span class="header-meta">Page generated: {{ generated_time }} <span id="page-age" class="page-age"></span></span>
{% endblock %}
{% block header_subtitle %}{% endblock %}

{% block content %}
  <!-- Legend/Help Section (keep consistent with commit history) -->
  <div class="container legend" style="margin-bottom: 0px; padding: 12px; background-color: #f6f8fa;">
    <details>
      <summary>
        Legend & Help
      </summary>
      <div style="margin-top: 10px; font-size: 12px; line-height: 1.55;">
        <div style="margin-bottom: 12px;">
          <div style="font-weight: 600; margin-bottom: 6px; color: #24292f;">CI Status Symbols (GitHub):</div>
          <ul style="margin: 4px 0; padding-left: 20px;">
            <li>{{ success_required_icon_html|safe }} / {{ success_icon_html|safe }} - Passed (required/optional)</li>
            <li>{{ failure_required_icon_html|safe }} / {{ failure_optional_icon_html|safe }} - Failed (required/optional)</li>
            <li>{{ in_progress_icon_html|safe }} - In progress</li>
            <li>{{ pending_icon_html|safe }} - Pending</li>
            <li>{{ cancelled_icon_html|safe }} - Canceled</li>
            <li>{{ skipped_icon_html|safe }} - Skipped</li>
          </ul>
          <div style="margin-top: 6px; color: #57606a; font-size: 12px;">
            Notes:
            <ul style="margin: 4px 0; padding-left: 20px;">
              <li><strong>Skipped</strong> shows as a grey circle-slash.</li>
              <li><strong>Optional failures</strong> show as a red ✗ (no circle) and do not force the top PASS/FAIL pill to FAIL.</li>
            </ul>
          </div>
        </div>

        <div style="margin-bottom: 12px;">
          <div style="font-weight: 600; margin-bottom: 6px; color: #24292f;">Subsections:</div>
          <ul style="margin: 4px 0; padding-left: 20px;">
            <li><strong>Build and Test - dynamo</strong>: shows phase breakdown (Build Image / Rust checks / pytest...) when available.</li>
            <li><strong>Long-running Actions jobs</strong> (e.g. <code>sglang (arm64)</code>, <code>trtllm (amd64)</code>): shows job steps with duration ≥ 30s.</li>
            <li>Step timing comes from the GitHub Actions job steps API and is cached; we only display steps ≥ 30s.</li>
          </ul>
        </div>

        <div style="margin-bottom: 6px;">
          <div style="font-weight: 600; margin-bottom: 6px; color: #24292f;">Links:</div>
          <ul style="margin: 4px 0; padding-left: 20px;">
            <li><strong>[log]</strong> opens the GitHub Actions job page.</li>
            <li><strong>“View”</strong> in Details points to the same URL as the tree’s <strong>[log]</strong> link.</li>
            <li><strong>[cached raw log]</strong> is a locally cached copy of the job log for failures (used for snippets/tags).</li>
          </ul>
        </div>
      </div>
    </details>
  </div>

  <pre>{{ tree_html | safe }}</pre>
{% endblock %}
