{% extends "common_dashboard.j2" %}
{% set refresh_seconds = 300 %}

{% block title %}Local Branch Info{% endblock %}
{% block favicon %}<link rel="icon" type="image/svg+xml" href="favicon.svg">{% endblock %}

{% block css %}
    .header a { color: #ffffff; text-decoration: none; }
    .header a:hover { text-decoration: underline; }
    .timestamp { margin: 5px 0 0 0; opacity: 0.9; font-size: 12px; }
    pre {
      background-color: #ffffff;
      border: 1px solid #d0d7de;
      border-radius: 4px;
      padding: 12px;
      /* Avoid nested scrollbars when expanding triangles; let the page scroll instead. */
      overflow: visible;
      /* Wrap long lines so we don't introduce horizontal scrollbars on expansion. */
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 13px;
      line-height: 1;
      margin: 0;
    }
    a { color: #0969da; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .repo-name { font-weight: bold; margin-top: 10px; }
    .current { font-weight: bold; }
    .merged-branch { color: #999999; }
    .indent { margin-left: 20px; }
    .error { color: #d73a49; }

    /* Status indicator pill (same look as show_commit_history.j2) */
    .status-indicator {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      margin-right: 6px;
      vertical-align: middle;
      font-size: 10px;
      font-weight: 600;
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border: 1px solid transparent;
    }
    .status-success { background-color: #2da44e; border-color: #1f7a37; }
    .status-failed { background-color: #d73a49; border-color: #b62d3b; }
    .status-warning { background-color: #dbab09; border-color: #b88f05; }
    .status-building { background-color: #dbab09; border-color: #b88f05; }
    .status-unknown { background-color: #8c959f; border-color: #6e7781; }
{% endblock %}

{# Error snippet toggle JS is shared in common_dashboard.j2 #}

{% block header_title %}Local Branch Info{% endblock %}
{% block header_subtitle %}
    <p class="timestamp">
      <span style="opacity: 0.92;">
        <a href="https://github.com/ai-dynamo/dynamo" target="_blank" title="Open ai-dynamo/dynamo on GitHub" style="display: inline-flex; align-items: center; gap: 6px;">
          <svg height="14" width="14" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: middle;">
            <path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z"></path>
          </svg>
          <span>GitHub</span>
        </a>
      </span>
      <span style="opacity: 0.6;">&nbsp;|&nbsp;</span>
      Page generated: {{ generated_time }} <span id="page-age" style="color: #ffa657;"></span>
    </p>
{% endblock %}

{% block content %}
  <!-- Legend/Help Section (keep consistent with commit history) -->
  <div class="container" style="margin-bottom: 0px; padding: 12px; background-color: #f6f8fa;">
    <details>
      <summary style="cursor: pointer; font-weight: 600; font-size: 14px; color: #24292f; user-select: none;">
        Legend & Help
      </summary>
      <div style="margin-top: 12px; font-size: 13px; line-height: 1.6;">
        <div style="margin-bottom: 12px;">
          <div style="font-weight: 600; margin-bottom: 6px; color: #24292f;">CI Status Symbols (GitHub):</div>
          <ul style="margin: 4px 0; padding-left: 20px;">
            <li>{{ success_required_icon_html|safe }} / {{ success_icon_html|safe }} - Passed (required/optional)</li>
            <li>{{ failure_required_icon_html|safe }} / {{ failure_optional_icon_html|safe }} - Failed (required/optional)</li>
            <li>{{ in_progress_icon_html|safe }} - In progress</li>
            <li>{{ pending_icon_html|safe }} - Pending</li>
            <li>{{ cancelled_icon_html|safe }} - Canceled</li>
            <li>{{ skipped_icon_html|safe }} - Skipped</li>
          </ul>
          <div style="margin-top: 6px; color: #57606a; font-size: 12px;">
            Notes:
            <ul style="margin: 4px 0; padding-left: 20px;">
              <li><strong>Skipped</strong> shows as a grey circle-slash.</li>
              <li><strong>Optional failures</strong> show as a red ✗ (no circle) and do not force the top PASS/FAIL pill to FAIL.</li>
            </ul>
          </div>
        </div>

        <div style="margin-bottom: 12px;">
          <div style="font-weight: 600; margin-bottom: 6px; color: #24292f;">Subsections:</div>
          <ul style="margin: 4px 0; padding-left: 20px;">
            <li><strong>Build and Test - dynamo</strong>: shows phase breakdown (Build Image / Rust checks / pytest...) when available.</li>
            <li><strong>Long-running Actions jobs</strong> (e.g. <code>sglang (arm64)</code>, <code>trtllm (amd64)</code>): shows job steps with duration ≥ 30s.</li>
            <li>Step timing comes from the GitHub Actions job steps API and is cached; we only display steps ≥ 30s.</li>
          </ul>
        </div>

        <div style="margin-bottom: 6px;">
          <div style="font-weight: 600; margin-bottom: 6px; color: #24292f;">Links:</div>
          <ul style="margin: 4px 0; padding-left: 20px;">
            <li><strong>[log]</strong> opens the GitHub Actions job page.</li>
            <li><strong>“View”</strong> in Details points to the same URL as the tree’s <strong>[log]</strong> link.</li>
            <li><strong>[cached raw log]</strong> is a locally cached copy of the job log for failures (used for snippets/tags).</li>
          </ul>
        </div>
      </div>
    </details>
  </div>

  <pre>{{ tree_html | safe }}</pre>
{% endblock %}
