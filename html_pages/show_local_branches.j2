{% extends "common_dashboard.j2" %}
{% set refresh_seconds = 300 %}
{% set refresh_check_interval_ms = 15000 %}

{% block title %}{{ page_title|default("Local Branch Info", true) }}{% endblock %}
{% block favicon %}<link rel="icon" type="image/svg+xml" href="favicon.svg">{% endblock %}

{% block css %}
    .header a { color: #ffffff; text-decoration: none; }
    .header a:hover { text-decoration: underline; }
    .timestamp { margin: 5px 0 0 0; opacity: 0.9; font-size: 12px; }
    pre {
      background-color: #ffffff;
      border: 1px solid #d0d7de;
      border-radius: 4px;
      padding: 12px;
      /* Avoid nested scrollbars when expanding triangles; let the page scroll instead. */
      overflow: visible;
      /* Wrap long lines so we don't introduce horizontal scrollbars on expansion. */
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
      font-size: 13px;
      line-height: 1;
      margin: 0;
    }
    a { color: #0969da; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .repo-name { font-weight: bold; margin-top: 10px; }
    .current { font-weight: bold; }
    .merged-branch { color: #999999; }
    .closed-branch { 
      background-color: #24292f; 
      color: #ffffff; 
      padding: 2px 6px; 
      border-radius: 3px; 
      font-weight: 600;
    }
    .indent { margin-left: 20px; }
    .error { color: #c83a3a; }

    /* Status indicator pill (same look as show_commit_history.j2) */
    .status-indicator {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      margin-right: 6px;
      vertical-align: middle;
      font-size: 10px;
      font-weight: 600;
      color: white;
      text-transform: uppercase;
      letter-spacing: 0.3px;
      border: 1px solid transparent;
    }
    .status-success { background-color: #2da44e; border-color: #1f7a37; }
    .status-failed { background-color: #c83a3a; border-color: #a83232; }
    .status-warning { background-color: #8c959f; border-color: #6e7781; }
    .status-building { background-color: #bf8700; border-color: #9a6a00; } /* RUNNING */
    .status-unknown { background-color: #8c959f; border-color: #6e7781; }
{% endblock %}

{# Error snippet toggle JS is shared in common_dashboard.j2 #}

{% block header_title %}
<span>{{ header_title|default("Local Branch Info", true) }}</span>
<span class="header-meta">Page generated: {{ generated_time }} <span id="page-age" class="page-age"></span></span>
{%- endblock -%}
{%- block header_subtitle -%}{%- endblock -%}
{%- block content %}
<!-- Legend/Help Section (keep consistent with commit history) -->
  <div class="container legend" style="margin-bottom: 0px; padding: 12px; background-color: #f6f8fa;">
    <details data-url-state="1" data-url-key="legend">
      <summary>
        <span style="display: inline-flex; align-items: center; justify-content: space-between; gap: 10px; width: calc(100% - 18px);">
          <span style="flex: 1 1 auto;">Legend &amp; Help</span>
          <button type="button"
                  onclick="event.preventDefault(); event.stopPropagation(); try { DashboardUrlState.resetView({reload: false}); } catch (e) {}"
                  style="flex: 0 0 auto; padding: 2px 8px; font-size: 11px; line-height: 1.2; background: transparent; color: #57606a; border: 1px solid #d0d7de; border-radius: 999px; cursor: pointer;"
                  title="Reset view (clears URL params and restores defaults)">
            Reset view
          </button>
        </span>
      </summary>
      <div style="margin-top: 10px; font-size: 12px; line-height: 1.55;">
        <div style="margin-bottom: 12px;">
          <div style="font-weight: 600; margin-bottom: 6px; color: #24292f;">CI Status Symbols:</div>
          <ul style="margin: 4px 0; padding-left: 20px;">
            <li>{{ success_required_icon_html|safe }} / {{ success_icon_html|safe }} - Passed (required/optional)</li>
            <li>{{ failure_required_icon_html|safe }} / {{ failure_optional_icon_html|safe }} - Failed (required/optional)</li>
            <li>{{ in_progress_icon_html|safe }} - In progress</li>
            <li>{{ pending_icon_html|safe }} - Pending</li>
            <li>{{ cancelled_icon_html|safe }} - Canceled</li>
            <li>{{ skipped_icon_html|safe }} - Skipped</li>
            <li><span style="display: inline-flex; align-items: center; justify-content: center; width: 12px; height: 12px; color: #8c959f; font-size: 12px; font-weight: 900;">◇</span> - Expected check (not yet returned by API)</li>
          </ul>
        </div>

        <div style="margin-bottom: 12px;">
          <div style="font-weight: 600; margin-bottom: 6px; color: #24292f;">Badges:</div>
          <ul style="margin: 4px 0; padding-left: 20px;">
            <li><span style="color: #c83a3a; font-weight: 700;">[REQUIRED]</span> - This check must pass for PR to be merged</li>
            <li><span style="color: #57606a; font-weight: 400;">[may be REQUIRED]</span> - Known required check not marked as required by API (cache/timing issue)</li>
          </ul>
        </div>

        <div style="margin-bottom: 12px;">
          <div style="font-weight: 600; margin-bottom: 6px; color: #24292f;">Job Steps:</div>
          <ul style="margin: 4px 0; padding-left: 20px;">
            <li><strong>Build and Test - dynamo</strong> shows phase breakdown (Build Image, Rust checks, pytest...)</li>
            <li><strong>Long-running jobs</strong> (≥10 min) show steps with duration ≥30s</li>
            <li><strong>Required jobs</strong> always show failing steps</li>
          </ul>
        </div>

        <div style="margin-bottom: 6px;">
          <div style="font-weight: 600; margin-bottom: 6px; color: #24292f;">Links:</div>
          <ul style="margin: 4px 0; padding-left: 20px;">
            <li><strong>[log]</strong> - GitHub Actions job page</li>
            <li><strong>[cached raw log]</strong> - Locally cached log for snippets</li>
          </ul>
        </div>
      </div>
    </details>
  </div>
  {# Optional sort control for pages that provide sortable branches #}
  {%- set _tree_alt = (tree_html_alt or "") %}
  {%- if tree_sortable is defined and tree_sortable %}
    <style>
      .sortable-branch {
      }
      .sortable-branch:first-child {
      }
    </style>
    <div class="container" style="margin-bottom: 6px; padding: 4px 0;">
      <span style="color: #57606a; font-size: 12px; font-weight: 600; margin-right: 8px;">Sort:</span>
      <label style="margin-right: 12px; cursor: pointer; user-select: none;">
        <input type="radio" name="tree-sort" value="modified" style="vertical-align: middle; margin-right: 4px;">
        <span style="vertical-align: middle;">latest modified</span>
      </label>
      <label style="margin-right: 12px; cursor: pointer; user-select: none;">
        <input type="radio" name="tree-sort" value="created" style="vertical-align: middle; margin-right: 4px;">
        <span style="vertical-align: middle;">latest created</span>
      </label>
      <label style="margin-right: 12px; cursor: pointer; user-select: none;">
        <input type="radio" name="tree-sort" value="branch" style="vertical-align: middle; margin-right: 4px;">
        <span style="vertical-align: middle;">branch name</span>
      </label>
    </div>

    <div id="tree-pre-sortable" style="font-family: ui-monospace, SFMono-Regular, 'SF Mono', Menlo, Consolas, 'Liberation Mono', monospace; font-size: 13px; line-height: 1.5; white-space: pre;">{{ tree_html | safe }}</div>

    <script>
      // Client-side reordering of sortable branch containers
      window.__dashboardOnReadyQueue = window.__dashboardOnReadyQueue || [];
      window.__dashboardOnReadyQueue.push(function() {
        try {
          var radios = document.querySelectorAll('input[name="tree-sort"]');
          var preEl = document.getElementById('tree-pre-sortable');
          if (!radios || !radios.length || !preEl) return;

          function _setRadio(val) {
            try {
              radios.forEach(function(r) { r.checked = (String(r.value||'') === String(val||'')); });
            } catch (e) {}
          }
          function _getRadio() {
            try {
              var v = 'modified';
              radios.forEach(function(r) { if (r.checked) v = String(r.value || 'modified'); });
              return v;
            } catch (e) { return 'modified'; }
          }

          // Set default (server-provided), then allow URL to override.
          try {
            var defv = String({{ (tree_sort_default or "modified")|tojson }});
            if (defv === 'latest') defv = 'modified';  // Map legacy 'latest' to 'modified'
            if (defv) _setRadio(defv);
          } catch (e) {}
          try {
            if (window.DashboardUrlState && typeof window.DashboardUrlState.get === 'function') {
              var v = window.DashboardUrlState.get('sort');
              if (v) {
                if (v === 'latest') v = 'modified';  // Map legacy 'latest' to 'modified'
                _setRadio(String(v));
              }
            }
          } catch (e) {}

          function apply() {
            try {
              var sortMode = String(_getRadio() || 'modified');
              var sortAttr = 'data-sort-' + sortMode;
              
              // Get all sortable branch containers
              var branches = Array.from(preEl.querySelectorAll('.sortable-branch'));
              if (!branches.length) return;
              
              // Sort them by the appropriate data attribute
              branches.sort(function(a, b) {
                var aKey = String(a.getAttribute(sortAttr) || '');
                var bKey = String(b.getAttribute(sortAttr) || '');
                
                // For timestamp-based sorts (modified, created), use numeric comparison
                if (sortMode === 'modified' || sortMode === 'created') {
                  var aNum = parseFloat(aKey.split('_')[0] || '0');
                  var bNum = parseFloat(bKey.split('_')[0] || '0');
                  return aNum - bNum;  // Ascending (negative timestamps, so most recent first)
                }
                
                // For branch name, use string comparison
                return aKey.localeCompare(bKey);
              });
              
              // Reattach in sorted order
              branches.forEach(function(br) {
                preEl.appendChild(br);
              });
              
              // Update URL state
              try {
                if (window.DashboardUrlState && typeof window.DashboardUrlState.setDefault === 'function') {
                  window.DashboardUrlState.setDefault('sort', sortMode, 'modified');
                }
              } catch (e) {}
            } catch (e) {}
          }
          radios.forEach(function(r) { r.addEventListener('change', apply); });
          apply();
        } catch (e) {}
      });
    </script>
  {% elif _tree_alt.strip() %}
    {# Legacy dual-tree approach (kept for backward compatibility if needed) #}
    {# Make IDs unique in the alternate tree by adding 'alt_' prefix to avoid conflicts with the main tree. #}
    {% set _tree_alt_unique = _tree_alt.replace('id="tree_children_k_', 'id="alt_tree_children_k_').replace('data-children-id="tree_children_k_', 'data-children-id="alt_tree_children_k_').replace('data-parent-children-id="tree_children_k_', 'data-parent-children-id="alt_tree_children_k_').replace('onclick="toggleTreeChildren(\'tree_children_k_', 'onclick="toggleTreeChildren(\'alt_tree_children_k_').replace('id="err_snip_', 'id="alt_err_snip_').replace('data-error-id="err_snip_', 'data-error-id="alt_err_snip_').replace('onclick="toggleErrorSnippet(\'err_snip_', 'onclick="toggleErrorSnippet(\'alt_err_snip_') %}
    <div class="container" style="margin-bottom: 6px; padding: 4px 0;">
      <span style="color: #57606a; font-size: 12px; font-weight: 600; margin-right: 8px;">Sort:</span>
      <label style="margin-right: 12px; cursor: pointer; user-select: none;">
        <input type="radio" name="tree-sort" value="latest" style="vertical-align: middle; margin-right: 4px;">
        <span style="vertical-align: middle;">latest</span>
      </label>
      <label style="margin-right: 12px; cursor: pointer; user-select: none;">
        <input type="radio" name="tree-sort" value="branch" style="vertical-align: middle; margin-right: 4px;">
        <span style="vertical-align: middle;">branch</span>
      </label>
    </div>

    <pre id="tree-pre-latest">{{ tree_html | safe }}</pre>
    <pre id="tree-pre-branch" style="display: none;">{{ _tree_alt_unique | safe }}</pre>

    <script>
      // Toggle between pre-rendered orderings (keeps the exact same look/feel as local branches).
      window.__dashboardOnReadyQueue = window.__dashboardOnReadyQueue || [];
      window.__dashboardOnReadyQueue.push(function() {
        try {
          var radios = document.querySelectorAll('input[name="tree-sort"]');
          var preLatest = document.getElementById('tree-pre-latest');
          var preBranch = document.getElementById('tree-pre-branch');
          if (!radios || !radios.length || !preLatest || !preBranch) return;

          function _setRadio(val) {
            try {
              radios.forEach(function(r) { r.checked = (String(r.value||'') === String(val||'')); });
            } catch (e) {}
          }
          function _getRadio() {
            try {
              var v = 'latest';
              radios.forEach(function(r) { if (r.checked) v = String(r.value || 'latest'); });
              return v;
            } catch (e) { return 'latest'; }
          }

          // Set default (server-provided), then allow URL to override.
          try {
            var defv = String({{ (tree_sort_default or "latest")|tojson }});
            if (defv) _setRadio(defv);
          } catch (e) {}
          try {
            if (window.DashboardUrlState && typeof window.DashboardUrlState.get === 'function') {
              var v = window.DashboardUrlState.get('sort');
              if (v) _setRadio(String(v));
            }
          } catch (e) {}

          function apply() {
            try {
              var v = String(_getRadio() || 'latest');
              var showBranch = (v === 'branch');
              preLatest.style.display = showBranch ? 'none' : 'block';
              preBranch.style.display = showBranch ? 'block' : 'none';
              
              // Re-apply URL state to the newly visible tree
              try {
                if (window.DashboardUrlState && window.DashboardUrlState._applyTreeToggles) {
                  // Wait a tick for display changes to take effect
                  setTimeout(function() {
                    try { window.DashboardUrlState._applyTreeToggles(); } catch (e) {}
                  }, 10);
                }
              } catch (e) {}
              
              try {
                if (window.DashboardUrlState && typeof window.DashboardUrlState.setDefault === 'function') {
                  window.DashboardUrlState.setDefault('sort', v, 'latest');
                }
              } catch (e) {}
            } catch (e) {}
          }
          radios.forEach(function(r) { r.addEventListener('change', apply); });
          apply();
        } catch (e) {}
      });
    </script>
  {% else %}
    {% if use_div_trees is defined and use_div_trees %}
      {{ tree_html | safe }}
    {% else %}
      <pre>{{ tree_html | safe }}</pre>
    {% endif %}
  {% endif %}
{% endblock %}
