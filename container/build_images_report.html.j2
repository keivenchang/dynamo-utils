<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
{% if running > 0 or queued > 0 %}
{# NOTE: no meta-refresh. We do a fault-tolerant JS auto-refresh instead (see tail script). #}
{% endif %}
<title>DynamoDockerBuilder - {{ sha_display }} - {{ overall_status }}</title>
<style>
body { font-family: Arial, sans-serif; margin: 10px; line-height: 1.3; }
.header { background-color: {{ header_color }}; color: white; padding: 15px 20px; border-radius: 4px; margin-bottom: 10px; text-align: center; }
.summary { background-color: #f8f9fa; padding: 4px 6px; border-radius: 2px; margin: 3px 0; }
.summary-boxes { width: 100%; margin: 15px 0; }
.summary-boxes table { width: 100%; border-collapse: separate; border-spacing: 10px; }
.summary-box { padding: 12px; border-radius: 6px; text-align: center; width: 25%; }
.summary-box.total { background: #e8f4f8; border-left: 4px solid #3498db; }
.summary-box.success { background: #e8f8f5; border-left: 4px solid #27ae60; }
.summary-box.failed { background: #fde8e8; border-left: 4px solid #e74c3c; }
.summary-box.skipped { background: #f9f9f9; border-left: 4px solid #95a5a6; }
.summary-box.killed { background: #fff3e0; border-left: 4px solid #ff9800; }
.summary-box .number { font-size: 28px; font-weight: bold; margin: 5px 0; display: block; }
.summary-box .label { font-size: 13px; color: #7f8c8d; text-transform: uppercase; font-weight: 600; display: block; }
.framework { margin: 10px 0; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px; background-color: #ffffff; }
.framework-header { background-color: #007bff; color: white; padding: 8px 12px; margin: -8px -8px 8px -8px; border-radius: 4px 4px 0 0; font-weight: bold; }
.results-chart { display: grid; grid-template-columns: auto 1fr 1fr auto auto auto auto; width: 100%; border-collapse: collapse; margin: 8px 0; }
.chart-row { display: contents; }
.chart-cell { padding: 6px 12px; border: 1px solid #dee2e6; vertical-align: middle; }
.chart-header { background-color: #f8f9fa; font-weight: bold; text-align: center; }
.chart-target { font-weight: bold; background-color: #f1f3f4; }
.chart-status { text-align: center; }
.chart-timing { text-align: right; font-family: monospace; font-size: 0.9em; }
.chart-cell-span-3 { grid-column: span 3; }
.success { color: #28a745; font-weight: bold; }
.failure { color: #dc3545; font-weight: bold; }
.git-info { background-color: #e9ecef; padding: 4px 6px; border-radius: 2px; font-family: monospace; font-size: 0.9em; }
a { color: #007bff; text-decoration: none; }
a:hover { text-decoration: underline; }
a.log-link { font-size: 0.85em; margin-left: 4px; }
p { margin: 1px 0; }
h2 { margin: 0; font-size: 1.2em; font-weight: bold; }

/* Auto-refresh connection banner (sleep/wake fault tolerance) */
.auto-refresh-banner {
  position: fixed;
  left: 10px;
  right: 10px;
  bottom: 10px;
  z-index: 9999;
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid #dee2e6;
  background: rgba(255, 255, 255, 0.96);
  color: #111;
  box-shadow: 0 4px 12px rgba(0,0,0,0.12);
  font-size: 12px;
  display: none;
  align-items: center;
  justify-content: space-between;
  gap: 12px;
}
.auto-refresh-banner .msg {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.auto-refresh-banner button {
  border: 1px solid #dee2e6;
  background: #f8f9fa;
  color: #111;
  border-radius: 8px;
  padding: 4px 10px;
  cursor: pointer;
  font-size: 12px;
  font-weight: 600;
  white-space: nowrap;
}
.auto-refresh-banner button:hover {
  background: #eef1f4;
}
</style>
</head>
<body>
<div class="header">
<h2>DynamoDockerBuilder - <a href="https://github.com/ai-dynamo/dynamo/commit/{{ sha_link }}" style="color: white; text-decoration: underline;">{{ sha_display }}</a> - {{ overall_status }}</h2>
<p style="margin: 5px 0 0 0; font-size: 0.9em; opacity: 0.9;">Report Generated: {{ report_generated }}</p>
</div>

<div class="summary-boxes">
<table>
<tr>
<td class="summary-box total">
<div class="number">{{ total_tasks }}</div>
<div class="label">Total Tasks</div>
</td>
<td class="summary-box success">
<div class="number">{{ succeeded }}</div>
<div class="label">Succeeded</div>
</td>
<td class="summary-box failed">
<div class="number">{{ failed }}</div>
<div class="label">Failed</div>
</td>
<td class="summary-box killed">
<div class="number">{{ killed }}</div>
<div class="label">Killed</div>
</td>
<td class="summary-box skipped">
<div class="number">{{ skipped }}</div>
<div class="label">Skipped</div>
</td>
</tr>
</table>
</div>

<div class="summary">
<p><strong>Build Date:</strong> {{ build_date }} </p>
</div>

<div class="git-info">
<p><strong>Commit SHA:</strong> <a href="https://github.com/ai-dynamo/dynamo/commit/{{ sha_link }}">{{ sha_display }}</a></p>
{%- if commit.pr_link %}
<p><strong>Pull Request:</strong> <a href="{{ commit.pr_link }}">#{{ commit.pr_number }}</a></p>
{%- endif %}
{%- if commit.date %}
<p><strong>Commit Date:</strong> {{ commit.date }} fixed</p>
<p><strong>Author:</strong> {{ commit.author }}</p>
<div style="background-color: #f8f9fa; padding: 6px; border-radius: 3px; margin: 3px 0;">
<strong>Commit Message:</strong>
<pre style="margin: 3px 0; white-space: pre-wrap; font-family: monospace; font-size: 0.9em;">{{ commit.message }}</pre>
</div>
{%- endif %}
{%- if commit.insertions is defined %}

<p><strong>Changes Summary:</strong> +{{ commit.insertions }}/-{{ commit.deletions }} lines</p>
{%- endif %}
{%- if commit.files_changed %}

<p><strong>Files Changed with Line Counts:</strong></p>
<div style="background-color: #f8f9fa; padding: 6px; border-radius: 3px; font-family: monospace; font-size: 0.9em; margin: 3px 0;">
{%- for file_path, file_stats in commit.files_changed|dictsort %}
{%- set insertions = file_stats.get('insertions', 0) %}
{%- set deletions = file_stats.get('deletions', 0) %}
{%- if insertions and deletions %}
‚Ä¢ {{ file_path }} +{{ insertions }}/-{{ deletions }}<br>
{%- elif insertions %}
‚Ä¢ {{ file_path }} +{{ insertions }}<br>
{%- elif deletions %}
‚Ä¢ {{ file_path }} -{{ deletions }}<br>
{%- endif %}
{%- endfor %}
</div>
{%- endif %}
</div>

{%- for framework_name in frameworks|sort %}
{%- set targets = frameworks[framework_name] %}

<div class="framework">
<div class="framework-header">{{ framework_name }}</div>
<div class="results-chart">
<div class="chart-row">
<div class="chart-cell chart-header">Target</div>
<div class="chart-cell chart-header">Input Image</div>
<div class="chart-cell chart-header">Output Image</div>
<div class="chart-cell chart-header">Build</div>
<div class="chart-cell chart-header">Compilation</div>
<div class="chart-cell chart-header">Sanity Check</div>
<div class="chart-cell chart-header">Image Size</div>
</div>
{%- for target_name in ['base', 'runtime', 'dev', 'dev-upload', 'local-dev'] %}
{%- if target_name in targets %}
{%- set target_data = targets[target_name] %}
{%- set build_task = target_data.build %}
{%- set compilation_task = target_data.compilation %}
{%- set sanity_task = target_data.sanity %}

<div class="chart-row">
<div class="chart-cell chart-target">{{ target_name }}</div>
<div class="chart-cell" style="font-family: monospace; font-size: 0.85em;">
{%- if target_data.input_image %}{{ target_data.input_image }}{%- else %}-{%- endif %}
</div>
<div class="chart-cell" style="font-family: monospace; font-size: 0.85em;">
{%- if target_name == 'dev-upload' and target_data.output_image %}
<button onclick="navigator.clipboard.writeText('{{ target_data.output_image }}').then(function(){alert('Copied to clipboard!');})" style="border: none; background: none; cursor: pointer; padding: 0 4px; font-size: 0.9em;" title="Copy to clipboard">üìã</button>{{ target_data.output_image }}
{%- elif target_data.output_image %}{{ target_data.output_image }}{%- else %}-{%- endif %}
</div>
{%- if target_name == 'dev-upload' %}
<div class="chart-cell chart-status chart-cell-span-3" style="text-align: center;">
{%- if build_task %}
{%- if build_task.status == 'passed' %}
<span class="success">‚úÖ UPLOADED</span>{%- if build_task.time %} <span class="chart-timing">({{ build_task.time }})</span>{%- endif %}
{%- elif build_task.status == 'running' %}
<span style="color: #3498db;">üîÑ UPLOADING</span>{%- if build_task.time %} <span class="chart-timing">(elapsed <span class="elapsed-seconds">{{ build_task.time.replace('elapsed ', '').replace('s', '') }}</span>s)</span>{%- endif %}
{%- elif build_task.status == 'killed' %}
<span style="color: #ff9800; font-weight: bold;">‚ö†Ô∏è KILLED</span>{%- if build_task.time %} <span class="chart-timing">({{ build_task.time }})</span>{%- endif %}
{%- elif build_task.status == 'queued' %}
<span style="color: #95a5a6;">‚è≥ to be uploaded</span>{%- if build_task.time %} <span class="chart-timing">(prev: {{ build_task.time }})</span>{%- endif %}
{%- elif build_task.status == 'skipped' %}
{%- if build_task.prev_status %}<span class="chart-timing">prev: <span class="success">UPLOADED</span>{%- if build_task.time %} ({{ build_task.time }}){%- endif %}</span>{%- endif %}
{%- else %}
<span class="failure">‚ùå FAIL</span> <span class="chart-timing">({{ build_task.time if build_task.time else 'n/a' }})</span>
{%- endif %}
{%- if build_task.log_file %} <a href="{{ build_task.log_file }}" class="log-link" target="_blank" rel="noopener noreferrer">[log]</a>{%- endif %}
{%- else %}-{%- endif %}
</div>
{%- else %}
<div class="chart-cell chart-status">
{%- if build_task %}
{%- if build_task.status == 'passed' %}
<span class="success">‚úÖ PASS</span>{%- if build_task.time %} <span class="chart-timing">({{ build_task.time }})</span>{%- endif %}
{%- elif build_task.status == 'running' %}
<span style="color: #3498db;">üîÑ RUNNING</span>{%- if build_task.time %} <span class="chart-timing">(elapsed <span class="elapsed-seconds">{{ build_task.time.replace('elapsed ', '').replace('s', '') }}</span>s)</span>{%- endif %}
{%- elif build_task.status == 'killed' %}
<span style="color: #ff9800; font-weight: bold;">‚ö†Ô∏è KILLED</span>{%- if build_task.time %} <span class="chart-timing">({{ build_task.time }})</span>{%- endif %}
{%- elif build_task.status == 'queued' %}
<span style="color: #95a5a6;">‚è≥ to be run</span>{%- if build_task.time %} <span class="chart-timing">(prev: {{ build_task.time }})</span>{%- endif %}
{%- elif build_task.status == 'skipped' %}
{%- if build_task.prev_status %}<span class="chart-timing">prev: {%- if build_task.prev_status == 'passed' %}<span class="success">PASS</span>{%- elif build_task.prev_status == 'killed' %}<span style="color: #ff9800; font-weight: bold;">KILLED</span>{%- else %}<span class="failure">FAIL</span>{%- endif %}{%- if build_task.time %} ({{ build_task.time }}){%- endif %}</span>{%- endif %}
{%- else %}
<span class="failure">‚ùå FAIL</span> <span class="chart-timing">({{ build_task.time if build_task.time else 'n/a' }})</span>
{%- endif %}
{%- if build_task.log_file %} <a href="{{ build_task.log_file }}" class="log-link" target="_blank" rel="noopener noreferrer">[log]</a>{%- endif %}
{%- else %}-{%- endif %}
</div>
<div class="chart-cell chart-status">
{%- if compilation_task %}
{%- if compilation_task.status == 'passed' %}
<span class="success">‚úÖ PASS</span>{%- if compilation_task.time %} <span class="chart-timing">({{ compilation_task.time }})</span>{%- endif %}
{%- elif compilation_task.status == 'running' %}
<span style="color: #3498db;">üîÑ RUNNING</span>{%- if compilation_task.time %} <span class="chart-timing">(elapsed <span class="elapsed-seconds">{{ compilation_task.time.replace('elapsed ', '').replace('s', '') }}</span>s)</span>{%- endif %}
{%- elif compilation_task.status == 'killed' %}
<span style="color: #ff9800; font-weight: bold;">‚ö†Ô∏è KILLED</span>{%- if compilation_task.time %} <span class="chart-timing">({{ compilation_task.time }})</span>{%- endif %}
{%- elif compilation_task.status == 'queued' %}
<span style="color: #95a5a6;">‚è≥ to be run</span>{%- if compilation_task.time %} <span class="chart-timing">(prev: {{ compilation_task.time }})</span>{%- endif %}
{%- elif compilation_task.status == 'skipped' %}
{%- if compilation_task.prev_status %}<span class="chart-timing">prev: {%- if compilation_task.prev_status == 'passed' %}<span class="success">PASS</span>{%- elif compilation_task.prev_status == 'killed' %}<span style="color: #ff9800; font-weight: bold;">KILLED</span>{%- else %}<span class="failure">FAIL</span>{%- endif %}{%- if compilation_task.time %} ({{ compilation_task.time }}){%- endif %}</span>{%- endif %}
{%- else %}
<span class="failure">‚ùå FAIL</span> <span class="chart-timing">({{ compilation_task.time if compilation_task.time else 'n/a' }})</span>
{%- endif %}
{%- if compilation_task.log_file %} <a href="{{ compilation_task.log_file }}" class="log-link" target="_blank" rel="noopener noreferrer">[log]</a>{%- endif %}
{%- else %}-{%- endif %}
</div>
<div class="chart-cell chart-status">
{%- if sanity_task %}
{%- if sanity_task.status == 'passed' %}
<span class="success">‚úÖ PASS</span>{%- if sanity_task.time %} <span class="chart-timing">({{ sanity_task.time }})</span>{%- endif %}
{%- elif sanity_task.status == 'running' %}
<span style="color: #3498db;">üîÑ RUNNING</span>{%- if sanity_task.time %} <span class="chart-timing">(elapsed <span class="elapsed-seconds">{{ sanity_task.time.replace('elapsed ', '').replace('s', '') }}</span>s)</span>{%- endif %}
{%- elif sanity_task.status == 'killed' %}
<span style="color: #ff9800; font-weight: bold;">‚ö†Ô∏è KILLED</span>{%- if sanity_task.time %} <span class="chart-timing">({{ sanity_task.time }})</span>{%- endif %}
{%- elif sanity_task.status == 'queued' %}
<span style="color: #95a5a6;">‚è≥ to be run</span>{%- if sanity_task.time %} <span class="chart-timing">(prev: {{ sanity_task.time }})</span>{%- endif %}
{%- elif sanity_task.status == 'skipped' %}
{%- if sanity_task.prev_status %}<span class="chart-timing">prev: {%- if sanity_task.prev_status == 'passed' %}<span class="success">PASS</span>{%- elif sanity_task.prev_status == 'killed' %}<span style="color: #ff9800; font-weight: bold;">KILLED</span>{%- else %}<span class="failure">FAIL</span>{%- endif %}{%- if sanity_task.time %} ({{ sanity_task.time }}){%- endif %}</span>{%- endif %}
{%- else %}
<span class="failure">‚ùå FAIL</span> <span class="chart-timing">({{ sanity_task.time if sanity_task.time else 'n/a' }})</span>
{%- endif %}
{%- if sanity_task.log_file %} <a href="{{ sanity_task.log_file }}" class="log-link" target="_blank" rel="noopener noreferrer">[log]</a>{%- endif %}
{%- else %}-{%- endif %}
</div>
{%- endif %}
<div class="chart-cell chart-timing">{{ target_data.image_size if target_data.image_size else '-' }}</div>
</div>
{%- endif %}
{%- endfor %}
</div></div>
{%- endfor %}
<script>
// Update elapsed time for all RUNNING tasks on a randomized cadence (0.25‚Äì0.5s).
// IMPORTANT: since cadence is not fixed, we increment by real elapsed wall time so it
// stays accurate even under timer throttling / sleep-wake.
function updateElapsedTimers() {
    const timers = document.querySelectorAll('.elapsed-seconds');

    timers.forEach(secondsSpan => {
        // Parse current value and add delta seconds
        const current = parseFloat(secondsSpan.textContent) || 0;
        secondsSpan.textContent = (current + window.__elapsedTimersDeltaSeconds).toFixed(1);
    });
}

// Randomized scheduler: 250ms to 500ms
(function scheduleElapsedTimerUpdates() {
    if (typeof window.__elapsedTimersLastTickMs !== 'number') {
        window.__elapsedTimersLastTickMs = Date.now();
    }

    const now = Date.now();
    const deltaSeconds = Math.max(0, (now - window.__elapsedTimersLastTickMs) / 1000.0);
    window.__elapsedTimersLastTickMs = now;
    window.__elapsedTimersDeltaSeconds = deltaSeconds;

    updateElapsedTimers();

    const delayMs = 250 + Math.random() * 250;
    window.setTimeout(scheduleElapsedTimerUpdates, delayMs);
})();

// Sleep/wake fault-tolerant auto-refresh (replaces meta refresh).
// Only active while builds are running/queued.
(function() {
    var shouldRefresh = {{ 'true' if (running > 0 or queued > 0) else 'false' }};
    if (!shouldRefresh) return;

    var baseDelayMs = 12000;
    var retryMs = 2000;
    var maxRetryMs = 60000;
    var retryTimer = null;
    var scheduledTimer = null;
    var lastTick = Date.now();

    function ensureBanner() {
        var el = document.getElementById('auto-refresh-banner');
        if (el) return el;
        el = document.createElement('div');
        el.id = 'auto-refresh-banner';
        el.className = 'auto-refresh-banner';
        el.innerHTML = '<div class="msg" id="auto-refresh-banner-msg"></div>' +
                       '<div style="display:flex; gap:8px; align-items:center;">' +
                       '<button id="auto-refresh-banner-retry" type="button">Retry now</button>' +
                       '</div>';
        document.body.appendChild(el);
        var btn = document.getElementById('auto-refresh-banner-retry');
        if (btn) btn.addEventListener('click', function() { attemptReloadSoon(0); });
        return el;
    }

    function setBanner(msg) {
        try {
            var el = ensureBanner();
            var msgEl = document.getElementById('auto-refresh-banner-msg');
            if (msgEl) msgEl.textContent = String(msg || '');
            el.style.display = 'inline-flex';
        } catch (e) {}
    }

    function hideBanner() {
        try {
            var el = document.getElementById('auto-refresh-banner');
            if (el) el.style.display = 'none';
        } catch (e) {}
    }

    function sleepAwareTick() {
        var now = Date.now();
        var delta = now - lastTick;
        lastTick = now;
        if (delta > 30000) attemptReloadSoon(250);
    }

    function buildPingUrl() {
        try {
            var u = new URL(window.location.href);
            u.hash = '';
            u.searchParams.set('__ping', String(Date.now()));
            return u.toString();
        } catch (e) {
            return String(window.location.href || '');
        }
    }

    function pingOnce() {
        var url = buildPingUrl();
        return fetch(url, { method: 'HEAD', cache: 'no-store', credentials: 'same-origin' })
            .then(function(resp) {
                if (resp && (resp.status === 405 || resp.status === 501)) {
                    return fetch(url, { method: 'GET', cache: 'no-store', credentials: 'same-origin' })
                        .then(function(r2) { return !!(r2 && r2.ok); })
                        .catch(function() { return false; });
                }
                return !!(resp && resp.ok);
            })
            .catch(function() { return false; });
    }

    function attemptReloadSoon(ms) {
        try { if (retryTimer) window.clearTimeout(retryTimer); } catch (e) {}
        retryTimer = window.setTimeout(attemptReload, Math.max(0, Number(ms || 0)));
    }

    function scheduleNextNormalRefresh() {
        try { if (scheduledTimer) window.clearTimeout(scheduledTimer); } catch (e) {}
        scheduledTimer = window.setTimeout(function() { attemptReloadSoon(0); }, baseDelayMs);
    }

    function attemptReload() {
        if (document.hidden) { scheduleNextNormalRefresh(); return; }
        try {
            if (navigator && navigator.onLine === false) {
                setBanner('Disconnected (offline). Keeping this page; retrying‚Ä¶');
                retryMs = Math.min(maxRetryMs, Math.floor(retryMs * 1.6));
                attemptReloadSoon(retryMs);
                return;
            }
        } catch (e) {}

        pingOnce().then(function(ok) {
            if (ok) {
                hideBanner();
                retryMs = 2000;
                try { window.location.reload(); } catch (e) {}
                return;
            }
            setBanner('Disconnected (server unreachable). Keeping this page; retrying‚Ä¶');
            retryMs = Math.min(maxRetryMs, Math.floor(retryMs * 1.6));
            attemptReloadSoon(retryMs);
        });
    }

    scheduleNextNormalRefresh();
    window.setInterval(sleepAwareTick, 5000);
    window.addEventListener('online', function() { attemptReloadSoon(250); });
    document.addEventListener('visibilitychange', function() {
        if (!document.hidden) attemptReloadSoon(250);
    });
})();
</script>
</body></html>

