{
    "$schema": "https://raw.githubusercontent.com/devcontainers/spec/main/schemas/devContainer.schema.json",
    "copyright": [
        "SPDX-FileCopyrightText: Copyright (c) {{ current_year }} NVIDIA CORPORATION & AFFILIATES. All rights reserved.",
        "SPDX-License-Identifier: Apache-2.0"
    ],
    "name": "{{ username}} {{ dirname }} {{ framework.upper() }}",
    "remoteUser": "dynamo", // Matches our container user
    "image": "dynamo:latest-{{ framework }}-local-dev", // Use the latest {{ framework.upper() }} dev image
    "overrideCommand": true, // Override the default command to keep container running
    "runArgs": [
        "--init", // Process reaper and signal forwarding
        "--gpus=all",
        "--network=host",
        "--ipc=host",
        "--cap-add=SYS_PTRACE",
        "--shm-size=10G",
        "--ulimit=memlock=-1",
        "--ulimit=stack=67108864",
        "--ulimit=nofile=65536:65536"
    ],
    "customizations": {
        "vscode": {
            "extensions": [
                "ms-python.python",
                "ms-python.vscode-pylance",
                "rust-lang.rust-analyzer",
                "eamodio.gitlens"
            ],
            "settings": {
                "dev.containers.copyGitConfig": false,
                "terminal.integrated.defaultProfile.linux": "bash",
                "terminal.integrated.cwd": "/workspace",
                "python.defaultInterpreterPath": "/opt/dynamo/venv/bin/python",
                "python.linting.enabled": true,
                "rust-analyzer.memoryLimit": 4096,
                "rust-analyzer.checkOnSave.command": "clippy",
                "rust-analyzer.checkOnSave.enable": true,
                "rust-analyzer.cargo.buildScripts.enable": true,
                "rust-analyzer.cargo.targetDir": "/workspace/target",
                "rust-analyzer.procMacro.enable": true,
                "rust-analyzer.completion.autoimport.enable": true,
                "rust-analyzer.linkedProjects": [
                    "Cargo.toml",
                    "lib/runtime/Cargo.toml",
                    "lib/llm/Cargo.toml",
                    "lib/tokens/Cargo.toml",
                    "lib/bindings/python/Cargo.toml",
                    "launch/dynamo-run/Cargo.toml"
                ],
                "files.trimTrailingWhitespace": true,
                "files.insertFinalNewline": true
            }
        }
    },
    "workspaceFolder": "/workspace",
    "workspaceMount": "source=${localWorkspaceFolder},target=/workspace,type=bind,consistency=cached",
    "userEnvProbe": "interactiveShell",
    "postCreateCommand": "/bin/bash /workspace/.devcontainer/post-create.sh", // Runs cargo build and pip installs packages
    "containerEnv": {
        "CARGO_PROFILE_DEV_OPT_LEVEL": "0",
        "CARGO_BUILD_JOBS": "32",
        "DYNAMO_USE_PREBUILT_KERNELS": "1"
    },
    "remoteEnv": {
        // Optional convenience tokens passed from host. SSH agent is forwarded via your IDE setting, not here by default.
        "GITHUB_TOKEN": "${localEnv:GITHUB_TOKEN}",
        "HF_TOKEN": "${localEnv:HF_TOKEN}"
        //"SSH_AUTH_SOCK": "${env:SSH_AUTH_SOCK}" // We mount /tmp which includes the socket
    },
    "mounts": [
        "source=dynamo-bashhistory,target=/home/dynamo/.commandhistory,type=volume",
        //"source=/tmp/,target=/tmp/,type=bind",
        "source=${localEnv:HOME}/.cache,target=/home/dynamo/.cache,type=bind",
        "source=${localEnv:HOME}/.cargo,target=/home/dynamo/.cargo,type=bind",
        "source=${localEnv:HOME}/.rustup,target=/home/dynamo/.rustup,type=bind",
        "source=${localEnv:HOME}/.bash_aliases,target=/home/dynamo/.bash_aliases,type=bind",
        "source=${localEnv:HOME}/.gitconfig,target=/home/dynamo/.gitconfig,type=bind",
        "source=${localEnv:HOME}/.gnupg,target=/home/dynamo/.gnupg,type=bind",
        "source=${localEnv:HOME}/.ssh,target=/home/dynamo/.ssh,type=bind,readonly",
        "source=${localEnv:HOME}/dynamo/dynamo-utils,target=/workspace/_,type=bind",
        "source=${localEnv:HOME}/dynamo/dynamo-utils/pyrightconfig.json,target=/workspace/pyrightconfig.json,type=bind",
        "source=${localEnv:HOME}/dynamo/dynamo-utils/.cursorrules,target=/workspace/.cursorrules,type=bind",
        "source=${localEnv:HOME}/dynamo/dynamo-utils/.cursorignore,target=/workspace/.cursorignore,type=bind"
    ]
}
