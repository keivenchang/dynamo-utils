# Cursor Rules for Dynamo Project
# https://github.com/keivenchang/dynamo-utils/blob/main/.cursorrules

# =============================================================================
# 1. PROJECT OVERVIEW
# =============================================================================

## Project Structure
# - Rust-based and Python-based project with Python bindings and web components
# - Build tools: cargo (Rust), uv (Python packages), maturin (Python bindings), Docker (containers)

## Key Components
# - Rust runtime and core libraries
# - Python bindings via maturin (lib/bindings/python)
# - Web components and interfaces
# - Frontend: lib/llm/src/http/* and lib/llm/src/http/service/metrics.rs
# - Backend: components/backends/* and lib/runtime/src/system_status_server.rs

## External Dependencies (Docker only)
# - tensorrt_llm: bin/ext/tensorrt_llm/*
# - vllm: bin/ext/vllm/*
# - sglang: bin/ext/sglang/*

# =============================================================================
# 2. AI PERSONALITY
# =============================================================================
# - Be direct, matter-of-fact, and honest about technical challenges
# - Don't be overly agreeable or sycophantic
# - Suggest alternatives when current approach has issues
# - Ask clarifying questions when requirements are unclear

# =============================================================================
# 3. UNIVERSAL CODE STYLE
# =============================================================================

## Emojis
# - DO NOT use emojis (unprofessional)
# - Rare exceptions only: ‚úÖ üö´ ‚ùå ‚ö†Ô∏è

## License Headers
# - Use first 2 lines only:
```
// SPDX-FileCopyrightText: Copyright (c) 2025 NVIDIA CORPORATION & AFFILIATES. All rights reserved.
// SPDX-License-Identifier: Apache-2.0
```

## General Rules
# - Don't remove TODO comments or commented lines below them
# - Don't generate *.md files unless explicitly requested
# - Verify HTML/markdown links work before adding them

# =============================================================================
# 4. RUST DEVELOPMENT
# =============================================================================

## Code Style
# - snake_case for variables/functions
# - PascalCase for types/traits
# - Use explicit types when it improves readability
# - Add doc comments (///) for public APIs
# - Prefer tracing::error over eprintln
# - Prefer shorter references: `MyStuff` instead of `crate::my_service::MyStuff`
# - Prefer .to_string() over format!() when possible
# - Prefer positive if/else: `if x then A else B` not `if !x then B else A`
#   - Exception: `if !x then A` (without else) is fine
# - Use debug_assert* over assert*

## File Organization
# - lib.rs: Library entry point
# - mod.rs: Module definitions
# - Separate files per module
# - Tests: tests/ directory or inline with #[cfg(test)]

## Build Commands
# - Always use --locked: cargo test --locked, cargo build --locked, cargo install --locked
# - Clean builds: cargo clean
# - CI build and test:
```
bash -ec 'rustup component add rustfmt clippy && \
          cargo fmt -- --check && \
          cargo clippy --features block-manager --no-deps --all-targets -- -D warnings && \
          (cd lib/bindings/python && cargo clippy --features block-manager --no-deps --all-targets -- -D warnings) && \
          cargo test --locked --all-targets --features=block-manager && \
          cargo test --locked --features integration -- --nocapture'
```

## Formatting and Linting
# - Run cargo fmt whenever there are significant Rust changes
# - Periodically run: cargo clippy --no-deps --all-targets -- -D warnings
# - Also run: (cd lib/bindings/python && cargo clippy --no-deps --all-targets -- -D warnings)

## Type Inference for Examples
# Add to top-level Cargo.toml [workspace] members (REMOVE BEFORE COMMIT):
```
# ======== AUTO ADDED FOR TYPE-INFERENCE, SHOULD BE REMOVED BEFORE COMMIT ========
"lib/runtime/examples/system_metrics",
"lib/runtime/examples/hello_world",
"lib/runtime/examples/service_metrics",
"lib/bindings/python",
# ======== AUTO ADDED FOR TYPE-INFERENCE, SHOULD BE REMOVED BEFORE COMMIT ========
```

## Type Inference for lib/bindings/python
# 1. Add "lib/bindings/python" to top-level Cargo.toml [workspace] members (see above)
# 2. Comment out [workspace] in lib/bindings/python/Cargo.toml:
```
# ======== WORKSPACE DECLARATION REMOVED FOR TYPE-INFERENCE, RESTORE BEFORE COMMIT ========
# [workspace]
# # empty workspace to exclude from top level workspace
# # excluded due to pyo3 extension module build issues
# ======== WORKSPACE DECLARATION REMOVED FOR TYPE-INFERENCE, RESTORE BEFORE COMMIT ========
```
# 3. Add empty integration feature to lib/bindings/python/Cargo.toml (if not present):
```
[features]
default = []
block-manager = ["dynamo-llm/block-manager", "dep:dlpark", "dep:cudarc"]
integration = []  # Empty feature for rust-analyzer compatibility
```
# 4. Restart rust-analyzer (Cmd/Ctrl+Shift+P ‚Üí "Rust Analyzer: Restart Server")
# 5. IMPORTANT: Restore all changes before committing

## Testing
# - Write unit tests in same file (unless told otherwise)
# - Use #[cfg(test)] for test-only code
# - Mock external dependencies when mocks are available
# - Integration tests use --features integration: cargo test --locked --features integration -- --nocapture
# - Specific integration test: cargo test --locked -p dynamo-runtime --features integration --lib http_server -- --nocapture
# - During tests, show progress if building/compiling
# - List which tests failed (up to 10) and pass/fail breakdown (unit vs integration)
# - For DistributedRuntime/Runtime/drt tests: use unique names (ns515, comp515, ep515)
#   - See lib/runtime/src/metrics.rs for examples

## Error Handling
# - Use Result<T, E> for fallible operations
# - Use Option<T> for nullable values
# - Prefer ? operator over match for error propagation
# - Use anyhow for application-level errors
```
pub fn process_data(data: &str) -> Result<ProcessedData, anyhow::Error> {
    let parsed = parse_input(data)?;
    let result = transform_data(parsed)?;
    Ok(result)
}
```

## Mutability Patterns
# Limit scope of mutable variables:
```
// Instead of:
let mut mut_var = ...;
mut_var.some_mutable_operation();
// ... mut_var used all over

// Do this:
let var = {
    let mut mut_var = ...;
    mut_var.some_mutable_operation();
    mut_var
};
```

## Lock Management
# Release locks before long operations:
```
// Bad:
let reg = self.registry.lock().unwrap();
if let Some(entry) = reg.get(name) {
    entry.execute_long_call()  // holds lock too long
}

// Good:
let long_call = {
    let reg = self.registry.lock().unwrap();
    reg.get(name).clone()
}; // Lock released here
long_call()
```

## Dependency Management
# Validate dependency updates:
```
cargo-deny --version || cargo install --locked cargo-deny@0.16.4
cargo-deny --no-default-features check --hide-inclusion-graph licenses bans --config deny.toml
```

## Python Bindings
# After changes in lib/bindings/python/rust/*, run: maturin develop

## Wheel Creation
# Create Python wheel (combine steps when possible):
```
cargo build --locked --features dynamo-llm/block-manager --workspace
cd lib/bindings/python && maturin develop
```
# If uv not installed: uv pip install maturin[patchelf]

# =============================================================================
# 5. PYTHON DEVELOPMENT
# =============================================================================

## Code Style
# - Follow PEP 8
# - Put imports at top of file (not inside functions)
# - Check indentation carefully (must be perfect)
# - Use dataclass for dicts with >4 elements (better type inference)
# - Use simple regex for multi-line string manipulations
# - snake_case for variables/functions
# - PascalCase for classes
# - Add type hints where beneficial
# - Use docstrings for functions/classes
# - Before commit: run mypy and precommit ruff
# - 3+ print statements: use triple quotes """ ... """
# - Outside Docker: source ~/bin/$(uname).$(uname -m)/venv.3.*/bin/activate

## File Organization
# - __init__.py for package initialization
# - Clear module separation
# - Tests in tests/ directory

## Error Handling
```
def process_file(filename: str) -> None:
    try:
        with open(filename, 'r') as f:
            data = f.read()
        process_data(data)
    except FileNotFoundError:
        logger.error(f"File {filename} not found")
        raise
```

## Testing
# - Framework: pytest
# - Unit tests in tests/ directory
# - Use fixtures for common setup
# - Mock external services
# - Always use: pytest --basetemp=/tmp/pytest_temp tests/

## End-to-End Backend Testing
# - E2E tests validate backend deployments with metrics
# - Validates dynamo_component_* metrics (‚â•23 unique) and backend-specific metrics
# - Backend thresholds (80% of typical):
#   - vLLM: ‚â•52 unique vllm:* metrics (~65 typical)
#   - SGLang: ‚â•20 unique sglang:* metrics (~25 typical)
#   - TensorRT-LLM: ‚â•4 unique trtllm:* metrics (~5 typical)

## Aggregated vs Disaggregated Mode
# - Aggregated: Single GPU, all components on one device
#   - Requires: DYN_SYSTEM_ENABLED=true DYN_SYSTEM_PORT=8081
# - Disaggregated: Multi-GPU, prefill/decode separation
#   - Requires 2+ GPUs
#   - Use aggregated mode for single GPU testing

## Backend E2E Tests
```
# Individual backend tests (aggregated with metrics):
pytest tests/serve/test_vllm.py::test_serve_deployment -k "aggregated" -v --tb=short
pytest tests/serve/test_sglang.py::test_sglang_deployment -k "aggregated" -v --tb=short
pytest tests/serve/test_trtllm.py::test_deployment -k "aggregated" -v --tb=short

# All backends (aggregated):
pytest tests/serve/ -k "aggregated" -v --tb=short

# Filtered output (recommended):
pytest tests/serve/ -k "aggregated" -v --tb=short | grep -v "running 0 tests" | grep -v "test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out" | grep -v "tower_http::trace::on_failure:"

# All serve tests (requires GPU):
pytest tests/serve/ -v --tb=short
```

## Metrics Server Configuration
# Backend launch scripts must include:
```
DYN_SYSTEM_ENABLED=true DYN_SYSTEM_PORT=8081 \
python -m dynamo.backend_name --model <model> [other_args]
```
# Without these: tests fail with "Connection refused" on port 8081

# =============================================================================
# 6. JAVASCRIPT/TYPESCRIPT
# =============================================================================
# - camelCase for variables/functions
# - PascalCase for components/classes
# - Prefer const over let, avoid var
# - Use async/await over .then() chains
# - Add JSDoc comments for complex functions

# =============================================================================
# 7. UNIX/SHELL COMMANDS
# =============================================================================

## General Rules
# - Source .bashrc when shell starts
# - Never use "!" inside shell quotes
# - No trailing spaces/tabs on empty lines
# - Use proper quoting to prevent word splitting/globbing

## File Operations
# - Check if file is under git before moving
# - Use git mv for tracked files, mv for untracked
# - Delete *.lock files instead of stashing

## Permissions
```
USER_ID=$(stat -c "%u" .)
GROUP_ID=$(stat -c "%g" .)
chown -R $USER_ID:$GROUP_ID .
```

## Piping and Filtering
# Filter out unimportant cargo test output with grep -v:
# - "running 0 tests"
# - "test result: ok. 0 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out"
# - "tower_http::trace::on_failure:"

## Multi-directory Commands
# cargo fmt in one step:
```
(cd $DYNAMO_HOME/lib/runtime/examples && cargo fmt); (cd $DYNAMO_HOME/lib/bindings/python && cargo fmt); (cd $DYNAMO_HOME && cargo fmt)
```

## Path Display
# - Use tilde (~) instead of full paths: ~/path not /home/ubuntu/path

## Pre-commit
# - Run pre-commit before commit

# =============================================================================
# 8. BUILD AND DEVELOPMENT WORKFLOW
# =============================================================================
# - cargo build --locked: Build Rust
# - uv build: Build Python packages
# - maturin build: Build Python extensions

# =============================================================================
# 9. GIT WORKFLOW
# =============================================================================

## Review Before Git Operations
# Periodically review this .cursorrules before git operations

## Merge Conflicts
# After resolving:
# 1. git add <resolved_files>
# 2. If in rebase: let user run git rebase --continue (don't open terminal)
# 3. Run cargo fmt on directories

## Commit Process
# - Never commit top-level Cargo.toml or Cargo.lock (unless explicitly told)
# - Never use --no-verify
# - Always use --signoff: git commit --signoff ...
# - Run cargo fmt before committing Rust changes
# - Never add untracked files (unless explicitly told)
# - List untracked files separately from modified files
# - Prompt to git add modified files
# - Diff changes and generate descriptive message
# - Single line message for straightforward changes

## Commit Message Format
# Subsequent commits (default): terse, 1 line or at most a couple lines
# - Quick fix of the module in XYZ ...
# - Documentation updates on XYZ ...
# - Minor changing the usage of XYZ ...
# - Renaming of XYZ to ZYX ...

# First/initial commits (when explicitly stated): verbose format
# - feat: add new user authentication system
# - fix: resolve memory leak in data processing
# - docs: update API documentation
# - test: add unit tests for user module
# - ci: configure continuous integration pipeline
# - refactor: restructure code for better readability
# - perf: optimize data processing for speed
# - chore: update dependencies and clean up
# - revert: undo previous commit due to issues
# - style: apply code formatting and style fixes
# - build: update build scripts for new environment

## Git Integration (for parsing commit messages)
# - Format: `title (#PR_NUMBER)`
# - Extract PR: r'\(#(\d+)\)'
# - GitHub repo: https://github.com/ai-dynamo/dynamo
# - Use full SHA for URLs, short SHA (7-9 chars) for display

# =============================================================================
# 10. COMMON CODE PATTERNS
# =============================================================================

## Terminal Width Detection
```
from common import get_terminal_width
width = get_terminal_width()  # Fallback to 80 if detection fails
```

# =============================================================================
# 11. SLACK RFR TEMPLATE
# =============================================================================
# Output format (fill <PR#NUMBER>, verify line counts, map GitHub to Slack logins). If <PR#NUMBER> is unknown, ask.
```
RFR (code: +123/-55 lines, documents: 50 lines changed):
*feat:* DIS-123 some feature desc here
*PR:* http://github.com/ai-dynamo/dynamo/pull/<PR#NUMBER>
*Reviewers:* <top reviewers based on past commits>, @Ryan McCormick, @Tanmay Verma
```
# Then add 3 terse bullets about the PR
# Output in plain text surrounded by triple backticks

## GitHub to Slack Login Mappings
# - rmccormick -> @Ryan McCormick
# - nv-tusharma, tusharma ‚Üí @Tushar Sharma
# - ishandhanani ‚Üí @Ishan Dhanani
# - anant-s ‚Üí @Anant Sharma
# - hhzhang16 ‚Üí @Hannah Zhang
# - grahamk ‚Üí @Graham King
# - krish ‚Üí @Krishnan Prashanth
# - yanrpei ‚Üí @Rudy Pei
# - biswa.panda ‚Üí @Biswa Ranjan Panda
# - tedzhouhk ‚Üí @Hongkuan Zhou
# - tzulingk ‚Üí @Tzu-Ling Kan
# - neelays ‚Üí @Neelay Shah
# - tanmayv25 ‚Üí @Tanmay Verma

# If 0 document lines changed, omit "documents: ..." section
# Never show literal <PR#NUMBER>, ask if unknown

# =============================================================================
# 12. GITHUB PR DESCRIPTION TEMPLATE
# =============================================================================
# Look at chain of continuous commits from same author
# Output in plain text surrounded by triple backticks (no formatting):
```
#### Overview:

<!-- 2-3 terse sentences based on commits -->

#### Details:

<!-- Bullet points describing changes -->

#### Where should the reviewer start?

<!-- Specific files to review closely -->

#### Related Issues: (use Closes / Fixes / Resolves / Relates to)

<!-- Linear ticket (DIS-123, DYN-789) extracted from commits, or leave blank -->

/coderabbit profile chill
```

# =============================================================================
# 13. DOCKER AND DEPLOYMENT
# =============================================================================
# - Multi-stage builds for smaller images
# - Set appropriate user permissions
# - Use .dockerignore
# - Pin dependency versions
# - DO NOT use bullshit BS jargon in Docker comments/docs: intuitive, comprehensive, optimal, 
#   seamless, next-generation, holistic, cutting-edge

## Example Dockerfile
```
FROM rust:1.70 as builder
WORKDIR /app
COPY . .
RUN cargo build --release

FROM debian:bullseye-slim
COPY --from=builder /app/target/release/app /usr/local/bin/
CMD ["app"]
```

# =============================================================================
# 14. PERFORMANCE AND OPTIMIZATION
# =============================================================================
# - Profile before optimizing
# - Use appropriate data structures
# - Consider memory allocation patterns
# - Use async/await for I/O
# - Cache expensive computations
# - Monitor resource usage in production

# =============================================================================
# 15. SECURITY
# =============================================================================
# - Never commit API keys or secrets
# - Use environment variables for config
# - Validate all user inputs
# - Use parameterized queries for databases
# - Follow principle of least privilege

# =============================================================================
# 16. DOCUMENTATION
# =============================================================================

## Comment Guidelines
# Always add comments for:
# - Complex algorithms
# - Business logic
# - API endpoints
# - Configuration options
# - Non-obvious code decisions

# Explain "why" not "what"
# - Bad: "Loop through items" (obvious)
# - Good: "Process items in batches to avoid memory issues"

## Forbidden Jargon
# DO NOT use these BS words in docs/comments:
# - intuitive, comprehensive, optimal, seamless
# - next-generation, holistic, cutting-edge

# =============================================================================
# 17. SPHINX DOCUMENTATION
# =============================================================================

## Overview
# - Source: docs/ directory
# - Build output: docs/build/html/
# - Main script: docs/generate_docs.py

## Build Documentation
```
cd ~/dynamo
python docs/generate_docs.py
```
# Steps: make clean ‚Üí preprocess_docs() ‚Üí make html

## Dependencies
```
pip install sphinx sphinx-rtd-theme myst-parser
```

## Smart Hyperlink Conversion
# docs/generate_docs.py converts links automatically:
# - GitHub URLs ‚Üí relative paths (for .md files in docs/)
#   Example: https://github.com/ai-dynamo/dynamo/blob/main/docs/guides/metrics.md ‚Üí ../../guides/metrics.md
# - Relative paths ‚Üí GitHub URLs (for non-.md or outside docs/)
#   Example: ../examples/config.pbtxt ‚Üí https://github.com/ai-dynamo/dynamo/blob/main/examples/config.pbtxt

## Adding New Files
# 1. Place file in appropriate subdirectory (docs/backends/*)
# 2. Add to docs/hidden_toctree.rst (for backend docs not in main TOC)
#    Example: backends/sglang/prometheus.md
# 3. Use relative paths (script handles conversion)
# 4. Test: python docs/generate_docs.py

## Toctree Structure
# - docs/index.rst: Main index
# - docs/_sections/*.rst: Section indexes
# - docs/hidden_toctree.rst: Hidden toctree for files not in main TOC
# - Backend docs order: TensorRT-LLM, SGLang, vLLM

## Build Warnings
# Sphinx uses -W flag (warnings = errors)
# - Missing toctree entries cause failures
# - All .md files must be referenced in a toctree
# - Check for: "WARNING: document isn't included in any toctree"

## Exclusions
# Files in docs/exclusions.txt are skipped during hyperlink conversion

# =============================================================================
# 18. DEBUGGING AND TROUBLESHOOTING
# =============================================================================
# - Use appropriate log levels (debug, info, warn, error)
# - Add context to error messages
# - Use structured logging when possible
# - Include relevant stack traces
# - Document common issues and solutions

# =============================================================================
# 19. CODE REVIEW GUIDELINES
# =============================================================================
# - Review for security vulnerabilities
# - Check for performance issues
# - Ensure proper error handling
# - Verify test coverage
# - Look for code duplication
# - Check adherence to conventions
