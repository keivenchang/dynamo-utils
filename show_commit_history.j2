<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="refresh" content="900">
<title>Dynamo Commit History</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='15' y='55' width='70' height='20' rx='3' fill='%232196f3'/><rect x='20' y='40' width='60' height='20' rx='3' fill='%234caf50'/><rect x='25' y='25' width='50' height='20' rx='3' fill='%23ff9800'/></svg>">
<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
    margin: 10px;
    line-height: 1.3;
    background-color: #f6f8fa;
    font-size: 13px;
}
.header {
    background-color: #24292f;
    color: white;
    padding: 10px 15px;
    border-radius: 4px;
    margin-bottom: 10px;
}
.header h1 {
    margin: 0;
    font-size: 18px;
}
.container {
    background-color: white;
    border: 1px solid #d0d7de;
    border-radius: 4px;
    overflow: hidden;
}
table {
    width: 100%;
    border-collapse: collapse;
    table-layout: auto;
}
th {
    background-color: #f6f8fa;
    padding: 6px 8px;
    text-align: left;
    font-weight: 600;
    border-bottom: 1px solid #d0d7de;
    position: sticky;
    top: 0;
    font-size: 12px;
    white-space: nowrap;
}
td {
    padding: 4px 8px;
    border-bottom: 1px solid #d0d7de;
    vertical-align: middle;
    line-height: 1.2;
}
/* Make message column single line and flexible */
td:last-child {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 0;
}
/* Prevent wrapping in other columns */
.sha, .date, .author {
    white-space: nowrap;
}
tr:hover {
    background-color: #f6f8fa;
}
.sha {
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    font-size: 12px;
    white-space: nowrap;
}
.sha a {
    color: #0969da;
    text-decoration: none;
}
.sha a:hover {
    text-decoration: underline;
}
.icon-link {
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    vertical-align: middle;
}
.gitlab-icons {
    display: inline-flex;
    align-items: center;
    gap: 2px;
    white-space: nowrap;
}
.icon-link:hover {
    opacity: 0.9;
}
.icon-muted {
    filter: grayscale(1);
    opacity: 0.55;
}
.message {
    color: #24292f;
}
.pr-link {
    color: #0969da;
    text-decoration: none;
    font-weight: 500;
}
.pr-link:hover {
    text-decoration: underline;
}
.release-forkpoint {
    display: inline-block;
    margin-left: 6px;
    padding: 1px 6px;
    border-radius: 999px;
    font-size: 11px;
    font-weight: 600;
    color: #0969da;
    background-color: #ddf4ff;
    border: 1px solid #80ccff;
    text-decoration: none;
    white-space: nowrap;
}
.release-forkpoint:hover {
    background-color: #b6e3ff;
    border-color: #54aeff;
    color: #0550ae;
    text-decoration: none;
}
.docker-images {
    margin-top: 8px;
}
details {
    margin-top: 4px;
}
summary {
    cursor: pointer;
    color: #0969da;
    font-size: 13px;
    font-weight: 500;
}
summary:hover {
    text-decoration: underline;
}
.image-list {
    margin: 8px 0;
    padding-left: 20px;
}
.image-tag {
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    font-size: 12px;
    background-color: #f6f8fa;
    padding: 2px 6px;
    border-radius: 3px;
    display: block;
    margin: 4px 0;
}
.date {
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    color: #57606a;
    font-size: 12px;
}
.author {
    color: #24292f;
    font-size: 14px;
}
.composite-sha-link {
    color: #0969da;
    text-decoration: none;
    cursor: pointer;
    border-bottom: 1px dotted #0969da;
}
.composite-sha-link:hover {
    text-decoration: underline;
}
.status-indicator {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    margin-right: 6px;
    vertical-align: middle;
    font-size: 10px;
    font-weight: 600;
    color: white;
    text-transform: uppercase;
    letter-spacing: 0.3px;
    border: 1px solid transparent;
}
a .status-indicator {
    cursor: pointer;
}
a .status-indicator:hover {
    opacity: 0.85;
    transform: translateY(-1px);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
.status-success {
    background-color: #2da44e;
    border-color: #1f7a37;
}
.status-failed {
    background-color: #d73a49;
    border-color: #b62d3b;
}
.status-building {
    background-color: #dbab09;
    border-color: #b08c00;
}
.status-success-inherited {
    background-color: #a8d5ba;
    border-color: #7bb697;
    color: #1f7a37;
}
.status-failed-inherited {
    background-color: #f5a3ab;
    border-color: #e67c87;
    color: #b62d3b;
}
.status-building-inherited {
    background-color: #f0d97d;
    border-color: #d4bd5e;
    color: #8b6f00;
}
.status-unknown {
    background-color: transparent;
    border: 1px solid #8c959f;
    color: #8c959f;
}

{{ gh_status_tooltip_css | safe }}
</style>
<script>
{{ gh_status_tooltip_js | safe }}

function toggleDockerImages(event, linkElement) {
    event.preventDefault();
    // Find the current row
    var currentRow = linkElement.closest('tr');
    // Find the next row (which should be the docker-images-row)
    var dockerRow = currentRow.nextElementSibling;

    if (dockerRow && dockerRow.classList.contains('docker-images-row')) {
        // Toggle visibility
        if (dockerRow.style.display === 'none') {
            dockerRow.style.display = 'table-row';
            linkElement.textContent = '‚ñº';  // Point down when expanded
        } else {
            dockerRow.style.display = 'none';
            linkElement.textContent = '‚ñ∂';  // Point right when collapsed
        }
    }
}

function toggleBuildHistory(event, shaShort) {
    event.preventDefault();
    event.stopPropagation();

    var historyDiv = document.getElementById('build-history-' + shaShort);

    // Close all other build history dropdowns
    var allHistories = document.querySelectorAll('[id^="build-history-"]');
    allHistories.forEach(function(div) {
        if (div.id !== 'build-history-' + shaShort) {
            div.style.display = 'none';
        }
    });

    // Toggle this one
    if (historyDiv.style.display === 'none' || historyDiv.style.display === '') {
        historyDiv.style.display = 'block';
    } else {
        historyDiv.style.display = 'none';
    }
}

// Close build history dropdown when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('[onclick^="toggleBuildHistory"]') &&
        !event.target.closest('[id^="build-history-"]')) {
        var allHistories = document.querySelectorAll('[id^="build-history-"]');
        allHistories.forEach(function(div) {
            div.style.display = 'none';
        });
    }
});

function copyToClipboard(text, button) {
    // Fallback for non-HTTPS contexts (file:// protocol)
    var textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        var successful = document.execCommand('copy');
        document.body.removeChild(textArea);

        if (successful) {
            var originalHTML = button.innerHTML;
            button.innerHTML = '<svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block;"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg><span style="margin-left: 6px;">Copied!</span>';
            setTimeout(function() {
                button.innerHTML = originalHTML;
            }, 2000);
        } else {
            alert('Failed to copy text');
        }
    } catch (err) {
        document.body.removeChild(textArea);
        alert('Failed to copy: ' + err);
    }
}

function copyFromClipboardAttr(button) {
    var text = button.getAttribute('data-clipboard-text');

    if (!text) {
        alert('No text found in data-clipboard-text attribute');
        return;
    }

    // Fallback for non-HTTPS contexts (file:// protocol)
    var textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        var successful = document.execCommand('copy');
        document.body.removeChild(textArea);

        if (successful) {
            var originalHTML = button.innerHTML;
            button.innerHTML = '<svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block;"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg><span style="margin-left: 6px;">Copied!</span>';
            setTimeout(function() {
                button.innerHTML = originalHTML;
            }, 2000);
        } else {
            alert('Failed to copy text');
        }
    } catch (err) {
        document.body.removeChild(textArea);
        alert('Failed to copy: ' + err);
    }
}
</script>
</head>
<body>

<div class="header">
<h1>Dynamo Commit History</h1>
<p style="margin: 5px 0 0 0; opacity: 0.9;">Recent commits with Composite Docker SHAs (CDS) and Docker images &nbsp;&nbsp;|&nbsp;&nbsp; <span style="opacity: 0.77; font-size: 12px;">Page generated: {{ generated_time }} <span id="page-age" style="color: #ffa657;"></span></span></p>
</div>

<!-- Key/Help Section -->
<div class="container" style="margin-bottom: 20px; padding: 12px; background-color: #f6f8fa;">
<details>
<summary style="cursor: pointer; font-weight: 600; font-size: 14px; color: #24292f; user-select: none;">
Legend & Help
</summary>
<div style="margin-top: 12px; font-size: 13px; line-height: 1.6;">
<div style="margin-bottom: 12px;">
<div style="font-weight: 600; margin-bottom: 6px; color: #24292f;">Icons & Links:</div>
<ul style="margin: 4px 0; padding-left: 20px;">
<li><strong>Local Build Status Indicators</strong> - Button appears in Composite Docker SHA column (left of CDS). Click the button to view build logs.
<ul style="margin: 2px 0; padding-left: 20px; font-size: 12px;">
<li><span class="status-indicator status-success" style="display: inline-block; vertical-align: middle;">PASS</span> Green - All builds/compile/sanity passed</li>
<li><span class="status-indicator status-failed" style="display: inline-block; vertical-align: middle;">FAIL</span> Red - Some builds/compile/sanity failed</li>
<li><span class="status-indicator status-building" style="display: inline-block; vertical-align: middle;">BUILD</span> Yellow - Build in progress</li>
<li><span class="status-indicator status-unknown" style="display: inline-block; vertical-align: middle;">----</span> Gray - No build status available</li>
<li><span class="status-indicator status-success-inherited" style="display: inline-block; vertical-align: middle;">PASS</span> Lighter color - Inherited status (no direct build for this commit)</li>
</ul>
</li>
<li><strong>CDS:xxxxxx</strong> - Composite Docker SHA: a unique hash representing the exact state of all files in the <code style="background-color: #f6f8fa; padding: 2px 4px; border-radius: 3px;">container/*</code> directory. This concept is unique to this dashboard.</li>
<li><strong>üê≥</strong> - Search NVIDIA GitLab Docker registry (appears in Status column)</li>
<li><strong><svg height="14" width="14" viewBox="0 0 16 16" fill="#24292f" style="display: inline-block; vertical-align: middle;"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z"></path></svg></strong> - View Github Actions logs (appears in Status column)</li>
<li><strong>ü¶ä</strong> - View commit in NVIDIA GitLab (appears in Status column with CI pipeline info)</li>
<li><strong>üõ†Ô∏è</strong> - View GitLab build pipeline (appears next to the ü¶ä icon when available)</li>
<li><strong>‚ñ∂</strong> - Expand to see Docker images and commit details</li>
</ul>
</div>
<div style="margin-bottom: 12px;">
<div style="font-weight: 600; margin-bottom: 6px; color: #24292f;">CI Status Symbols (Github & NVIDIA GitLab):</div>
<ul style="margin: 4px 0; padding-left: 20px;">
<li><span style="color: #2da44e;">‚úì</span> - Checks/jobs passed or succeeded</li>
<li><span style="color: #d73a49;">‚úó</span> - Checks/jobs failed</li>
<li><span style="color: #dbab09;">‚è≥</span> - Checks/jobs in progress or running</li>
<li><span style="color: #8c959f;">‚è∏</span> - Checks/jobs pending (not started yet)</li>
<li><span style="color: #8c959f;">‚úñÔ∏è</span> - Checks/jobs canceled</li>
</ul>
<p style="margin: 4px 0; color: #57606a; font-size: 12px;">Example: <span style="color: #2da44e;">21‚úì</span> <span style="color: #d73a49;">1‚úó</span> <span style="color: #dbab09;">1‚è≥</span> <span style="color: #8c959f;">3‚è∏</span> <span style="color: #8c959f;">1‚úñÔ∏è</span> means 21 passed, 1 failed, 1 in progress, 3 pending, 1 canceled.</p>
</div>
</div>
</details>
</div>

<script>
// Calculate and display page age
(function() {
    // Parse the generated time string more reliably
    const timeStr = '{{ generated_time }}';
    // Replace PST/PDT with timezone offset
    const timeStrFixed = timeStr.replace(' PST', '-08:00').replace(' PDT', '-07:00');
    const generatedTime = new Date(timeStrFixed);

    function updatePageAge() {
        const now = new Date();
        const ageMs = now - generatedTime;

        // Check if date parsed correctly
        if (isNaN(generatedTime.getTime())) {
            document.getElementById('page-age').textContent = '(invalid date)';
            return;
        }

        // Calculate time components
        const seconds = Math.floor(ageMs / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        let ageText = '';
        if (days > 0) {
            ageText = `(${days} day${days > 1 ? 's' : ''} ${hours % 24} hour${(hours % 24) !== 1 ? 's' : ''} old)`;
        } else if (hours > 0) {
            ageText = `(${hours} hour${hours > 1 ? 's' : ''} ${minutes % 60} min old)`;
        } else if (minutes > 0) {
            ageText = `(${minutes} minute${minutes > 1 ? 's' : ''} old)`;
        } else {
            ageText = `(${seconds} second${seconds !== 1 ? 's' : ''} old)`;
        }

        document.getElementById('page-age').textContent = ageText;
    }

    // Update immediately and then every 3 seconds
    updatePageAge();
    setInterval(updatePageAge, 3000);
})();
</script>

<div class="container">
<table>
<thead>
<tr>
<th>Commit SHA</th>
<th>Composite Docker SHA</th>
<th>Github Status</th>
<th>GitLab Status</th>
<th>Date/Time (PST)</th>
<th>Author</th>
<th style="width: 100%;">Message</th>
</tr>
</thead>
<tbody>

{% for commit in commits %}
{%- set sha_short = commit.sha_short -%}
{%- set sha_full = commit.sha_full -%}
{%- set composite_sha = commit.composite_sha -%}
{%- set date_str = commit.date -%}
{%- set author = commit.author -%}
{%- set message = commit.message -%}
{%- set commit_link = "https://github.com/ai-dynamo/dynamo/commit/" ~ sha_full -%}
{%- set gitlab_commit_link = "https://gitlab-master.nvidia.com/dl/ai-dynamo/dynamo/-/commit/" ~ sha_full -%}
{%- set has_docker_images = sha_short in docker_images and docker_images[sha_short] -%}
{%- set has_gitlab = sha_full in gitlab_images and gitlab_images[sha_full] -%}
{%- set composite_bg_color = commit.composite_bg_color -%}
{%- set pipeline = gitlab_pipelines.get(sha_full) -%}
{%- set pr_number = commit.pr_number -%}
{%- set mr_pipeline = mr_pipelines.get(pr_number) if pr_number else none -%}
{%- set effective_pipeline = pipeline if pipeline else mr_pipeline -%}

<tr>
<td class="sha">
<a href="{{ commit_link }}" target="_blank">{{ sha_short }}</a>
</td>
<td class="sha">
{%- set log_paths_list = log_paths.get(sha_short, []) -%}
{%- set status_info = build_status.get(sha_short, {}) -%}
{%- set status = status_info.get('status', 'unknown') -%}
{%- set inherited = status_info.get('inherited', False) -%}
{# Local build status indicator before CDS #}
{%- if log_paths_list -%}
{# Most recent build (last in list) #}
{%- set latest_date, latest_path = log_paths_list[-1] -%}
{%- if status == 'success' -%}
<a href="{{ latest_path }}" target="_blank" style="text-decoration: none;" title="{%- if inherited -%}Inherited: {%- endif -%}All builds passed - Click to view build logs"><span class="status-indicator status-success{%- if inherited -%}-inherited{%- endif -%}">PASS</span></a>
{%- elif status == 'failed' -%}
<a href="{{ latest_path }}" target="_blank" style="text-decoration: none;" title="{%- if inherited -%}Inherited: {%- endif -%}Some builds failed - Click to view build logs"><span class="status-indicator status-failed{%- if inherited -%}-inherited{%- endif -%}">FAIL</span></a>
{%- elif status == 'building' -%}
<a href="{{ latest_path }}" target="_blank" style="text-decoration: none;" title="{%- if inherited -%}Inherited: {%- endif -%}Build in progress - Click to view build logs"><span class="status-indicator status-building{%- if inherited -%}-inherited{%- endif -%}">BUILD</span></a>
{%- elif status == 'unknown' -%}
<span class="status-indicator status-unknown" title="No build status available">----</span>
{%- endif -%}
<span style="background-color: {{ composite_bg_color }}; color: {{ commit.composite_text_color | default('#24292f') }}; padding: 2px 6px; border-radius: 3px; margin-left: 4px;">CDS:{{ composite_sha[:6] }}</span>{# Show history icon if multiple builds exist #}{%- if log_paths_list|length > 1 -%}<a href="#" onclick="toggleBuildHistory(event, '{{ sha_short }}'); return false;" style="text-decoration: none; margin-left: 2px; font-size: 11px; color: #656d76;" title="Show build history ({{ log_paths_list|length }} builds)">üìã</a><div id="build-history-{{ sha_short }}" style="display: none; position: absolute; background: #fff; border: 1px solid #d0d7de; border-radius: 6px; padding: 8px; margin-top: 4px; z-index: 1000; box-shadow: 0 8px 24px rgba(140, 149, 159, 0.2);"><div style="font-weight: 600; font-size: 12px; margin-bottom: 6px; color: #24292f;">Build History</div>{%- for date, path in log_paths_list|reverse -%}<div style="padding: 4px 0;"><a href="{{ path }}" target="_blank" style="color: #0969da; text-decoration: none; font-size: 12px;">{{ date }}</a>{%- if loop.first -%} <span style="color: #656d76; font-size: 11px;">(latest)</span>{%- endif -%}</div>{%- endfor -%}</div>{%- endif -%}{%- if has_docker_images or has_gitlab -%}<a href="#" class="composite-sha-link" onclick="toggleDockerImages(event, this); return false;" style="text-decoration: none; margin-left: 4px;" title="Show Docker images">‚ñ∂</a>{%- endif -%}
{%- else -%}
{# No build logs - show non-clickable status indicators #}
{%- if status == 'success' -%}
<span class="status-indicator status-success{%- if inherited -%}-inherited{%- endif -%}" title="{%- if inherited -%}Inherited: {%- endif -%}All builds passed">PASS</span>
{%- elif status == 'failed' -%}
<span class="status-indicator status-failed{%- if inherited -%}-inherited{%- endif -%}" title="{%- if inherited -%}Inherited: {%- endif -%}Some builds failed">FAIL</span>
{%- elif status == 'building' -%}
<span class="status-indicator status-building{%- if inherited -%}-inherited{%- endif -%}" title="{%- if inherited -%}Inherited: {%- endif -%}Build in progress">BUILD</span>
{%- elif status == 'unknown' -%}
<span class="status-indicator status-unknown" title="No build status available">----</span>
{%- endif -%}
<span style="background-color: {{ composite_bg_color }}; color: {{ commit.composite_text_color | default('#24292f') }}; padding: 2px 6px; border-radius: 3px; margin-left: 4px;">CDS:{{ composite_sha[:6] }}</span>{%- if has_docker_images or has_gitlab -%}<a href="#" class="composite-sha-link" onclick="toggleDockerImages(event, this); return false;" style="text-decoration: none; margin-left: 4px;" title="Show Docker images">‚ñ∂</a>{%- endif -%}
{%- endif -%}
</td>
<td class="sha">
{# GitHub Actions status for GHA badge color #}
{%- set gha_status = github_actions_status.get(sha_full) -%}
{%- if gha_status and gha_status.conclusion == 'success' -%}
{%- set gha_color = '#2da44e' -%}
{%- set gha_title = 'Github Actions: All checks passed' -%}
{%- elif gha_status and gha_status.conclusion == 'failure' -%}
{%- set gha_color = '#d73a49' -%}
{%- set gha_title = 'Github Actions: Some checks failed' -%}
{%- elif gha_status and gha_status.status == 'in_progress' -%}
{%- set gha_color = '#dbab09' -%}
{%- set gha_title = 'Github Actions: Checks in progress' -%}
{%- elif gha_status and gha_status.conclusion == 'cancelled' -%}
{%- set gha_color = '#8c959f' -%}
{%- set gha_title = 'Github Actions: Checks cancelled' -%}
{%- else -%}
{%- set gha_color = '#8c959f' -%}
{%- set gha_title = 'Github Actions: No checks' -%}
{%- endif -%}
{# Github section #}
<a href="https://github.com/ai-dynamo/dynamo/commit/{{ sha_full }}/checks" target="_blank" style="text-decoration: none; color: #24292f; font-weight: 600;" title="{{ gha_title }}"><svg height="14" width="14" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block; vertical-align: middle;"><path fill-rule="evenodd" clip-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8C0 11.54 2.29 14.53 5.47 15.59C5.87 15.66 6.02 15.42 6.02 15.21C6.02 15.02 6.01 14.39 6.01 13.72C4 14.09 3.48 13.23 3.32 12.78C3.23 12.55 2.84 11.84 2.5 11.65C2.22 11.5 1.82 11.13 2.49 11.12C3.12 11.11 3.57 11.7 3.72 11.94C4.44 13.15 5.59 12.81 6.05 12.6C6.12 12.08 6.33 11.73 6.56 11.53C4.78 11.33 2.92 10.64 2.92 7.58C2.92 6.71 3.23 5.99 3.74 5.43C3.66 5.23 3.38 4.41 3.82 3.31C3.82 3.31 4.49 3.1 6.02 4.13C6.66 3.95 7.34 3.86 8.02 3.86C8.7 3.86 9.38 3.95 10.02 4.13C11.55 3.09 12.22 3.31 12.22 3.31C12.66 4.41 12.38 5.23 12.3 5.43C12.81 5.99 13.12 6.7 13.12 7.58C13.12 10.65 11.25 11.33 9.47 11.53C9.76 11.78 10.01 12.26 10.01 13.01C10.01 14.08 10 14.94 10 15.21C10 15.42 10.15 15.67 10.55 15.59C13.71 14.53 16 11.53 16 8C16 3.58 12.42 0 8 0Z"></path></svg></a>
{# Per-commit GH checks status (split required vs optional failures, plus pending vs cancelled) #}
{%- set commit_stats = gha_per_commit_stats.get(sha_full, {'success_required': 0, 'success_optional': 0, 'failure_required': 0, 'failure_optional': 0, 'in_progress_required': 0, 'in_progress_optional': 0, 'pending': 0, 'cancelled': 0, 'other': 0, 'total': 0}) -%}
{%- if commit_stats.total > 0 -%}
{# Build detailed tooltip with job names #}
{%- set gha_status = github_actions_status.get(sha_full) -%}
{%- set passed_required_jobs = [] -%}
{%- set passed_optional_jobs = [] -%}
{%- set failed_required_jobs = [] -%}
{%- set failed_optional_jobs = [] -%}
{%- set progress_required_jobs = [] -%}
{%- set progress_optional_jobs = [] -%}
{%- set pending_jobs = [] -%}
{%- set cancelled_jobs = [] -%}
{%- set other_jobs = [] -%}
{%- if gha_status and gha_status.get('check_runs') -%}
{%- for check in gha_status.get('check_runs', []) -%}
{%- if check.conclusion == 'success' -%}
{%- if check.is_required -%}
{%- set _ = passed_required_jobs.append(check.name) -%}
{%- else -%}
{%- set _ = passed_optional_jobs.append(check.name) -%}
{%- endif -%}
{%- elif check.conclusion in ('failure', 'timed_out', 'action_required') -%}
{%- if check.is_required -%}
{%- set _ = failed_required_jobs.append(check.name) -%}
{%- else -%}
{%- set _ = failed_optional_jobs.append(check.name) -%}
{%- endif -%}
{%- elif check.status == 'in_progress' -%}
{%- if check.is_required -%}
{%- set _ = progress_required_jobs.append(check.name) -%}
{%- else -%}
{%- set _ = progress_optional_jobs.append(check.name) -%}
{%- endif -%}
{%- elif check.status in ('queued', 'pending') -%}
{%- set _ = pending_jobs.append(check.name) -%}
{%- elif check.conclusion == 'cancelled' -%}
{%- set _ = cancelled_jobs.append(check.name) -%}
{%- else -%}
{%- set _ = other_jobs.append(check.name) -%}
{%- endif -%}
{%- endfor -%}
{%- endif -%}
{%- set tooltip_html_parts = [] -%}
{%- if passed_required_jobs -%}{%- set _ = tooltip_html_parts.append('<strong style="color: #2da44e;">‚úì Passed (required):</strong> ' + (passed_required_jobs|sort)|join(', ')) -%}{%- endif -%}
{%- if passed_optional_jobs -%}{%- set _ = tooltip_html_parts.append('<strong style="color: #2da44e;">‚úì Passed (optional):</strong> ' + (passed_optional_jobs|sort)|join(', ')) -%}{%- endif -%}
{%- if failed_required_jobs -%}{%- set _ = tooltip_html_parts.append('<strong style="color: #d73a49;"><span style="display: inline-flex; align-items: center; justify-content: center; width: 14px; height: 14px; margin-right: 6px; border-radius: 999px; background-color: #d73a49; color: #ffffff; font-size: 11px; font-weight: 900; line-height: 1;">‚úó</span>Failed (required):</strong> ' + (failed_required_jobs|sort)|join(', ')) -%}{%- endif -%}
{%- if failed_optional_jobs -%}{%- set _ = tooltip_html_parts.append('<strong style="color: #f59e0b;">‚ö† Failed (optional):</strong> ' + (failed_optional_jobs|sort)|join(', ')) -%}{%- endif -%}
{%- if progress_required_jobs -%}{%- set _ = tooltip_html_parts.append('<strong style="color: #dbab09;">‚è≥ In Progress (required):</strong> ' + (progress_required_jobs|sort)|join(', ')) -%}{%- endif -%}
{%- if progress_optional_jobs -%}{%- set _ = tooltip_html_parts.append('<strong style="color: #8c959f;">‚è≥ In Progress (optional):</strong> ' + (progress_optional_jobs|sort)|join(', ')) -%}{%- endif -%}
{%- if pending_jobs -%}{%- set _ = tooltip_html_parts.append('<strong style="color: #8c959f;">‚è∏ Pending:</strong> ' + (pending_jobs|sort)|join(', ')) -%}{%- endif -%}
{%- if cancelled_jobs -%}{%- set _ = tooltip_html_parts.append('<strong style="color: #8c959f;">‚úñÔ∏è Canceled:</strong> ' + (cancelled_jobs|sort)|join(', ')) -%}{%- endif -%}
{%- if other_jobs -%}{%- set _ = tooltip_html_parts.append('<strong style="color: #8c959f;">Other:</strong> ' + (other_jobs|sort)|join(', ')) -%}{%- endif -%}
{%- set tooltip_html = tooltip_html_parts|join('<br>') -%}
<span class="gh-status-tooltip" style="margin-left: 4px;">
<span style="white-space: nowrap; font-weight: 600; font-size: 11px;">
{%- set success_total = (commit_stats.success_required | int) + (commit_stats.success_optional | int) -%}
{%- if (commit_stats.success_required | int) > 0 or (commit_stats.success_optional | int) > 0 -%}
<span style="color: #2da44e;">
  <strong>{{ commit_stats.success_required }}</strong>
  {%- if (commit_stats.success_optional | int) > 0 -%}<span style="{{ pass_plus_style }}">+{{ commit_stats.success_optional }}</span>{%- endif -%}‚úì
</span>
{%- endif -%}
{%- if commit_stats.failure_required > 0 -%}{%- if success_total > 0 %} {% endif -%}<span style="color: #d73a49; font-weight: 800; font-size: 12px;" title="Required failures">{{ commit_stats.failure_required }}<span style="display: inline-flex; align-items: center; justify-content: center; width: 12px; height: 12px; margin-left: 2px; border-radius: 999px; background-color: #d73a49; color: #ffffff; font-size: 10px; font-weight: 900; line-height: 1;">‚úó</span></span>{%- endif -%}
{%- if commit_stats.failure_optional > 0 -%}{%- if success_total > 0 or commit_stats.failure_required > 0 %} {% endif -%}<span style="color: #f59e0b;" title="Optional failures">{{ commit_stats.failure_optional }}<span style="font-size: 13px; font-weight: 900; line-height: 1; margin-left: 2px;">‚ö†</span></span>{%- endif -%}
{%- set inprog_total = commit_stats.in_progress_required + commit_stats.in_progress_optional -%}
{%- if inprog_total > 0 -%}{%- if success_total > 0 or commit_stats.failure_required > 0 or commit_stats.failure_optional > 0 %} {% endif -%}<span style="color: #dbab09;">{{ inprog_total }}‚è≥</span>{%- endif -%}
{%- if commit_stats.pending > 0 -%}{%- if success_total > 0 or commit_stats.failure_required > 0 or commit_stats.failure_optional > 0 or inprog_total > 0 %} {% endif -%}<span style="color: #8c959f;">{{ commit_stats.pending }}‚è∏</span>{%- endif -%}
{%- if commit_stats.cancelled > 0 -%}{%- if success_total > 0 or commit_stats.failure_required > 0 or commit_stats.failure_optional > 0 or inprog_total > 0 or commit_stats.pending > 0 %} {% endif -%}<span style="color: #8c959f;">{{ commit_stats.cancelled }}‚úñÔ∏è</span>{%- endif -%}
</span>
<span class="tooltiptext">{{ tooltip_html|safe }}</span>
</span>
{%- endif -%}
</td>
<td class="sha">
{# GitLab section #}
<span class="gitlab-icons">
{# Always show GitLab commit link (fox). Gray it out if we don't have pipeline context. #}
<a href="{{ gitlab_commit_link }}" target="_blank" class="icon-link{%- if not effective_pipeline -%} icon-muted{%- endif -%}" style="color: #fc6d26; font-weight: 600;" title="View commit in GitLab">ü¶ä</a>

{# Registry search icon (whale). Always linked; gray out if no pipeline context. #}
<a href="https://gitlab-master.nvidia.com/dl/ai-dynamo/dynamo/container_registry/85325?orderBy=PUBLISHED_AT&sort=desc&search%5B%5D={{ sha_full }}" target="_blank" class="icon-link{%- if not effective_pipeline -%} icon-muted{%- endif -%}" style="color: #2496ed; font-weight: 600;" title="{%- if effective_pipeline -%}Search GitLab Docker registry for this SHA{%- else -%}No GitLab pipeline context (search registry anyway){%- endif -%}">üê≥</a>

{# Pipeline icon (build link). Uses SHA pipeline if present, else MR pipeline as fallback. #}
{%- if effective_pipeline and effective_pipeline.web_url -%}
<a href="{{ effective_pipeline.web_url }}" target="_blank" class="icon-link" style="color: #0969da;" title="View build pipeline in GitLab">üõ†Ô∏è</a>
{%- else -%}
<span class="icon-link icon-muted" title="No pipeline found for this commit/PR">üõ†Ô∏è</span>
{%- endif -%}
 </span>

{%- if pipeline -%}
{%- set job_data = pipeline_job_counts.get(pipeline.id) -%}
{%- if job_data -%}
{# Handle both old format (direct counts) and new format (counts + jobs) #}
{%- if job_data.counts -%}
{# New format: {'counts': {...}, 'jobs': [...]} #}
{%- set job_counts = job_data.counts -%}
{%- set has_job_details = job_data.jobs is defined and job_data.jobs -%}
{%- else -%}
{# Old format: {'success': N, 'failed': N, ...} - treat as counts directly #}
{%- set job_counts = job_data -%}
{%- set has_job_details = false -%}
{%- endif -%}
{# Build detailed tooltip with job names if available #}
{%- if has_job_details -%}
{%- set success_jobs = [] -%}
{%- set failed_required_jobs = [] -%}
{%- set failed_optional_jobs = [] -%}
{%- set running_required_jobs = [] -%}
{%- set running_optional_jobs = [] -%}
{%- set pending_jobs = [] -%}
{%- set canceled_jobs = [] -%}
{%- for job in job_data.jobs -%}
{# Mandatory job names: contains ".pre" OR starts with "build" OR starts with "test" #}
{%- set job_name = job.name or "" -%}
{%- set job_stage_raw = (job.stage if job.stage is defined else "") or "unknown" -%}
{# GitLab stage "pre" is typically shown as ".pre" in the UI; normalize for readability #}
{%- set job_stage = ".pre" if job_stage_raw == "pre" else job_stage_raw -%}
{%- set job_label = job_stage ~ "." ~ job_name -%}
{# Mandatory are: .pre, build, test (match on either stage or full label) #}
{%- set is_required = (job_name.startswith(".pre") or (".pre" in job_label) or (job_stage in ("pre", ".pre")) or job_name.startswith("build") or job_name.startswith("test")) -%}
{%- if job.status == 'success' -%}
{%- set _ = success_jobs.append(job_label) -%}
{%- elif job.status == 'failed' -%}
{%- if is_required -%}
{%- set _ = failed_required_jobs.append(job_label) -%}
{%- else -%}
{%- set _ = failed_optional_jobs.append(job_label) -%}
{%- endif -%}
{%- elif job.status == 'running' -%}
{%- if is_required -%}
{%- set _ = running_required_jobs.append(job_label) -%}
{%- else -%}
{%- set _ = running_optional_jobs.append(job_label) -%}
{%- endif -%}
{%- elif job.status in ('pending', 'created', 'waiting_for_resource') -%}
{%- set _ = pending_jobs.append(job_label) -%}
{%- elif job.status == 'canceled' -%}
{%- set _ = canceled_jobs.append(job_label) -%}
{%- endif -%}
{%- endfor -%}
{%- set gitlab_tooltip_parts = [] -%}
{%- if success_jobs -%}{%- set _ = gitlab_tooltip_parts.append('<strong style="color: #2da44e;">‚úì Passed:</strong> ' + (success_jobs|sort)|join(', ')) -%}{%- endif -%}
{%- if failed_required_jobs -%}{%- set _ = gitlab_tooltip_parts.append('<strong style="color: #d73a49;"><span style="display: inline-flex; align-items: center; justify-content: center; width: 14px; height: 14px; margin-right: 6px; border-radius: 999px; background-color: #d73a49; color: #ffffff; font-size: 11px; font-weight: 900; line-height: 1;">‚úó</span>Failed (mandatory):</strong> ' + (failed_required_jobs|sort)|join(', ')) -%}{%- endif -%}
{%- if failed_optional_jobs -%}{%- set _ = gitlab_tooltip_parts.append('<strong style="color: #f59e0b;">‚ö† Failed (non-mandatory):</strong> ' + (failed_optional_jobs|sort)|join(', ')) -%}{%- endif -%}
{%- if running_required_jobs -%}{%- set _ = gitlab_tooltip_parts.append('<strong style="color: #dbab09;">‚è≥ In Progress (mandatory):</strong> ' + (running_required_jobs|sort)|join(', ')) -%}{%- endif -%}
{%- if running_optional_jobs -%}{%- set _ = gitlab_tooltip_parts.append('<strong style="color: #8c959f;">‚è≥ In Progress (non-mandatory):</strong> ' + (running_optional_jobs|sort)|join(', ')) -%}{%- endif -%}
{%- if pending_jobs -%}{%- set _ = gitlab_tooltip_parts.append('<strong style="color: #8c959f;">‚è∏ Pending:</strong> ' + (pending_jobs|sort)|join(', ')) -%}{%- endif -%}
{%- if canceled_jobs -%}{%- set _ = gitlab_tooltip_parts.append('<strong style="color: #8c959f;">‚úñÔ∏è Canceled:</strong> ' + (canceled_jobs|sort)|join(', ')) -%}{%- endif -%}
{%- set gitlab_tooltip_html = gitlab_tooltip_parts|join('<br>') -%}
<span class="gh-status-tooltip" style="margin-left: 4px;">
<span style="white-space: nowrap; font-weight: 600; font-size: 11px;">
{%- if job_counts.success > 0 -%}<span style="color: #2da44e;">{{ job_counts.success }}‚úì</span>{%- endif -%}
{%- set req_failed = failed_required_jobs|length -%}
{%- set opt_failed = failed_optional_jobs|length -%}
{%- if req_failed > 0 -%}{%- if job_counts.success > 0 %} {% endif -%}<span style="color: #d73a49; font-weight: 800; font-size: 12px;" title="Mandatory failures">{{ req_failed }}<span style="display: inline-flex; align-items: center; justify-content: center; width: 12px; height: 12px; margin-left: 2px; border-radius: 999px; background-color: #d73a49; color: #ffffff; font-size: 10px; font-weight: 900; line-height: 1;">‚úó</span></span>{%- endif -%}
{%- if opt_failed > 0 -%}{%- if job_counts.success > 0 or req_failed > 0 %} {% endif -%}<span style="color: #f59e0b;" title="Non-mandatory failures">{{ opt_failed }}<span style="font-size: 13px; font-weight: 900; line-height: 1; margin-left: 2px;">‚ö†</span></span>{%- endif -%}
{%- set inprog_total = (running_required_jobs|length) + (running_optional_jobs|length) -%}
{%- if inprog_total > 0 -%}{%- if job_counts.success > 0 or req_failed > 0 or opt_failed > 0 %} {% endif -%}<span style="color: #dbab09;">{{ inprog_total }}‚è≥</span>{%- endif -%}
{%- if job_counts.pending > 0 -%}{%- if job_counts.success > 0 or job_counts.failed > 0 or job_counts.running > 0 %} {% endif -%}<span style="color: #8c959f;">{{ job_counts.pending }}‚è∏</span>{%- endif -%}
{%- if job_counts.canceled > 0 -%}{%- if job_counts.success > 0 or req_failed > 0 or opt_failed > 0 or inprog_total > 0 or job_counts.pending > 0 %} {% endif -%}<span style="color: #8c959f;">{{ job_counts.canceled }}‚úñÔ∏è</span>{%- endif -%}
</span>
{%- if gitlab_tooltip_html -%}
<span class="tooltiptext">{{ gitlab_tooltip_html|safe }}</span>
{%- endif -%}
</span>
{%- else -%}
{# Old format or no job details - just show counts without tooltip #}
<a href="{{ pipeline.web_url }}" target="_blank" style="margin-left: 4px; text-decoration: none; font-weight: 600; font-size: 11px;" title="Click to view pipeline">
{%- if job_counts.success > 0 -%}<span style="color: #2da44e;">{{ job_counts.success }}‚úì</span>{%- endif -%}
{%- if job_counts.failed > 0 -%}{%- if job_counts.success > 0 %} {% endif -%}<span style="color: #d73a49;">{{ job_counts.failed }}‚úó</span>{%- endif -%}
{%- if job_counts.running > 0 -%}{%- if job_counts.success > 0 or job_counts.failed > 0 %} {% endif -%}<span style="color: #dbab09;">{{ job_counts.running }}‚è≥</span>{%- endif -%}
{%- if job_counts.pending > 0 -%}{%- if job_counts.success > 0 or job_counts.failed > 0 or job_counts.running > 0 %} {% endif -%}<span style="color: #8c959f;">{{ job_counts.pending }}‚è∏</span>{%- endif -%}
{%- if job_counts.canceled > 0 -%}{%- if job_counts.success > 0 or job_counts.failed > 0 or job_counts.running > 0 or job_counts.pending > 0 %} {% endif -%}<span style="color: #8c959f;">{{ job_counts.canceled }}‚úñÔ∏è</span>{%- endif -%}
</a>
{%- endif -%}
{%- endif -%}
{%- endif -%}
</td>
<td class="date">{{ date_str }}</td>
<td class="author">{{ author }}</td>
<td>
<div class="message">{{ message | safe }}</div>
{%- if commit.release_forkpoints -%}
<div style="margin-top: 2px;">
{%- for fp in commit.release_forkpoints -%}
<a class="release-forkpoint" href="{{ fp.url }}" target="_blank" title="Fork-point for {{ fp.branch }}">{{ fp.label }}</a>
{%- endfor -%}
</div>
{%- endif -%}
</td>
</tr>

{# Docker images row if any exist for this SHA #}
{% if has_docker_images or has_gitlab %}
{%- set images = docker_images.get(sha_short, []) -%}
{%- set full_msg = commit.full_message -%}
{%- set files_changed = commit.files_changed -%}
{%- set insertions = commit.insertions -%}
{%- set deletions = commit.deletions -%}
{%- set changed_files = commit.changed_files -%}
{%- set gitlab_imgs = gitlab_images.get(sha_full, []) -%}

<tr class="docker-images-row" style="display: none;">
<td colspan="7" style="padding: 0; background-color: #f6f8fa;">
<div style="padding: 8px 12px; border-top: 1px solid #d0d7de;">
<!-- Commit Details Section -->
<div style="margin-bottom: 12px; padding: 8px; background-color: white; border: 1px solid #d0d7de; border-radius: 4px;">
<div style="font-weight: 600; margin-bottom: 6px; font-size: 13px;">Commit Message:</div>
<div style="font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; font-size: 12px; color: #24292f; white-space: pre-wrap; margin-bottom: 8px;">{{ full_msg | e }}</div>
<div style="font-size: 12px; color: #57606a; margin-top: 6px;">
<span style="color: #1a7f37; font-weight: 500;">+{{ insertions }}</span>
<span style="color: #cf222e; font-weight: 500;">-{{ deletions }}</span>
<span style="margin-left: 8px;">{{ files_changed }} file(s) changed</span>
</div>
<details style="margin-top: 8px;">
<summary style="cursor: pointer; color: #0969da; font-size: 12px;">Show changed files ({{ changed_files|length }})</summary>
<div style="margin-top: 4px; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; font-size: 11px;">
{% for file in changed_files %}
<div style="padding: 2px 0;">{{ file }}</div>
{% endfor %}
</div>
</details>
</div>

{# GitLab Container Registry Section #}
{% if gitlab_imgs %}
<div style="margin-bottom: 12px; padding: 8px; background-color: white; border: 1px solid #d0d7de; border-radius: 4px;">
<div style="font-weight: 600; margin-bottom: 4px; font-size: 13px;">GitLab Container Registry (Runtime Images): <a href="https://gitlab-master.nvidia.com/dl/ai-dynamo/dynamo/container_registry/{{ gitlab_imgs[0].registry_id }}" target="_blank" style="color: #fc6d26; text-decoration: none; font-weight: 600; font-size: 12px;" title="View all images in GitLab Container Registry">ü¶ä View Registry</a></div>
<table style="width: 100%; border: none; background-color: white; border-collapse: collapse;">
<thead>
<tr>
<th style="width: 35%; padding: 3px 6px; border: none;">Image Name:Tag</th>
<th style="width: 10%; padding: 3px 6px; border: none;">pull runtime</th>
{# TODO: Add back "make localdev" column later #}
{# {% if gitlab_imgs|selectattr('arch', 'equalto', 'amd64')|selectattr('framework', 'in', ['trtllm', 'vllm'])|list|length > 0 %}<th style="width: 10%; padding: 3px 6px; border: none;">make localdev</th>{% endif %} #}
<th style="width: 10%; padding: 3px 6px; border: none;">Build ID</th>
<th style="width: 8%; padding: 3px 6px; border: none;">Size</th>
<th style="width: 27%; padding: 3px 6px; border: none;">Created (PDT)</th>
</tr>
</thead>
{# Macro to generate docker pull, wget Dockerfile, and build command (multi-line format with early stop on error)
   Example output:
   (BASE_IMAGE=gitlab-master.nvidia.com:5005/dl/ai-dynamo/dynamo:2f18b23ee7163df21f20e872b83ada4226fbf851-38897884-vllm-amd64 && \
   docker pull ${BASE_IMAGE} && \
   wget http://keivenc-linux/nvidia/dynamo-utils/container/Dockerfile.runtime_localdev_venv -O /tmp/Dockerfile.runtime_localdev_venv && \
   docker build -f /tmp/Dockerfile.runtime_localdev_venv --build-arg BASE_IMAGE=${BASE_IMAGE} --build-arg USER_UID=$(id -u) --build-arg USER_GID=$(id -g) -t dynamo:2f18b23e-vllm-local-dev /tmp && \
   echo 'Build SUCCESS! Run with: container/run.sh --image dynamo:2f18b23e-vllm-local-dev --mount-workspace -it ...')
   Note: sha_short is accessed from outer scope (commit loop)
   Note: sglang uses Dockerfile.runtime_localdev_system, vllm/trtllm use Dockerfile.runtime_localdev_venv
#}
{% macro docker_pull_tag_cmd(img, sha_short) -%}
{%- set local_tag = "dynamo:" ~ sha_short ~ "-" ~ img.framework ~ "-local-dev" -%}
{%- if img.framework|upper == "SGLANG" -%}
{%- set dockerfile_name = "Dockerfile.runtime_localdev_system" -%}
{%- else -%}
{%- set dockerfile_name = "Dockerfile.runtime_localdev_venv" -%}
{%- endif -%}
{%- set dockerfile_url = "http://keivenc-linux/nvidia/dynamo-utils/container/" ~ dockerfile_name -%}
{%- set dockerfile_path = "/tmp/" ~ dockerfile_name -%}
(BASE_IMAGE={{ img.location }} && \
docker pull ${BASE_IMAGE} && \
wget {{ dockerfile_url }} -O {{ dockerfile_path }} && \
docker build -f {{ dockerfile_path }} --build-arg BASE_IMAGE=${BASE_IMAGE} --build-arg USER_UID=$(id -u) --build-arg USER_GID=$(id -g) -t {{ local_tag }} /tmp && \
echo 'Build SUCCESS! Run with: container/run.sh --image {{ local_tag }} --mount-workspace -it ...')
{%- endmacro %}

<tbody>
{% for img in gitlab_imgs %}
{%- set arch_label = "[x86]" if img.arch == "amd64" else "[ARM]" -%}
{%- set display_tag = arch_label ~ " " ~ img.tag -%}
{%- set image_id = img.pipeline_id[:12] if img.pipeline_id|length >= 12 else img.pipeline_id -%}
<tr>
<td style="font-family: monospace; font-size: 11px; padding: 2px 6px; border: none; max-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ img.tag }}
Pipeline: {{ img.pipeline_id }}
Framework: {{ img.framework }}">{{ display_tag }}</td>
<td style="font-size: 11px; padding: 2px 6px; border: none; white-space: nowrap;"><button data-clipboard-text="docker pull {{ img.location }}" onclick="copyFromClipboardAttr(this)" style="padding: 4px 6px; font-size: 11px; background-color: transparent; color: #57606a; border: 1px solid #d0d7de; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; vertical-align: middle;" title="Click to copy docker pull command for runtime image" onmouseover="this.style.backgroundColor='#f3f4f6'; this.style.borderColor='#8c959f';" onmouseout="this.style.backgroundColor='transparent'; this.style.borderColor='#d0d7de';"><svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block;"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg></button><span style="margin-left: 6px;">copy command</span></td>
{# TODO: Add back "make localdev" column later #}
{# {% if gitlab_imgs|selectattr('arch', 'equalto', 'amd64')|selectattr('framework', 'in', ['trtllm', 'vllm'])|list|length > 0 %}<td style="font-size: 11px; padding: 2px 6px; border: none; white-space: nowrap;">{% if img.arch == "amd64" and (img.framework|upper == "TRTLLM" or img.framework|upper == "VLLM") %}<button data-clipboard-text="{{ docker_pull_tag_cmd(img, sha_short) }}" onclick="copyFromClipboardAttr(this)" style="padding: 4px 6px; font-size: 11px; background-color: transparent; color: #57606a; border: 1px solid #d0d7de; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; vertical-align: middle;" title="Click to copy command for creating local-dev image: Pulls the runtime image, downloads Dockerfile, builds a local-dev container with your UID/GID, and shows how to run it" onmouseover="this.style.backgroundColor='#f3f4f6'; this.style.borderColor='#8c959f';" onmouseout="this.style.backgroundColor='transparent'; this.style.borderColor='#d0d7de';"><svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block;"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg></button><span style="margin-left: 6px;">copy command</span>{% endif %}</td>{% endif %} #}
<td style="font-family: monospace; font-size: 11px; padding: 2px 6px; border: none;"><a href="https://gitlab-master.nvidia.com/dl/ai-dynamo/dynamo/-/pipelines/{{ img.pipeline_id }}" target="_blank" style="color: #0969da;" title="View pipeline {{ img.pipeline_id }}">{{ image_id }}</a></td>
<td style="font-size: 11px; padding: 2px 6px; border: none;">{{ img.size_display }}</td>
<td style="font-size: 11px; padding: 2px 6px; border: none;">{{ img.created_display }}</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% endif %}

<!-- Docker Images Section -->
{% if images %}
<div style="margin-bottom: 12px; padding: 8px; background-color: white; border: 1px solid #d0d7de; border-radius: 4px;">
<div style="font-weight: 600; margin-bottom: 4px; font-size: 13px;">Local Docker Images:</div>
<table style="width: 100%; border: none; background-color: white; border-collapse: collapse;">
<thead>
<tr>
<th style="width: 50%; padding: 3px 6px; border: none;">Image Name:Tag</th>
<th style="width: 15%; padding: 3px 6px; border: none;">Image ID</th>
<th style="width: 10%; padding: 3px 6px; border: none;">Size</th>
<th style="width: 25%; padding: 3px 6px; border: none;">Created (PDT)</th>
</tr>
</thead>
<tbody>
{% for image in images | sort(attribute='tag') %}
<tr>
<td style="font-family: monospace; font-size: 11px; padding: 2px 6px; border: none;">{{ image.tag }}</td>
<td style="font-family: monospace; font-size: 11px; padding: 2px 6px; border: none;">{{ image.id }}</td>
<td style="font-size: 11px; padding: 2px 6px; border: none;">{{ image.size }}</td>
<td style="font-size: 11px; padding: 2px 6px; border: none;">{{ image.created }}</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% endif %}

</div>
</td>
</tr>
{% endif %}

{% endfor %}

</tbody>
</table>
</div>

</body>
</html>

