<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta http-equiv="refresh" content="900">
<title>Dynamo Commit History</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect x='15' y='55' width='70' height='20' rx='3' fill='%232196f3'/><rect x='20' y='40' width='60' height='20' rx='3' fill='%234caf50'/><rect x='25' y='25' width='50' height='20' rx='3' fill='%23ff9800'/></svg>">
<style>
body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans', Helvetica, Arial, sans-serif;
    margin: 10px;
    line-height: 1.3;
    background-color: #f6f8fa;
    font-size: 13px;
}
.header {
    background-color: #24292f;
    color: white;
    padding: 10px 15px;
    border-radius: 4px;
    margin-bottom: 10px;
}
.header h1 {
    margin: 0;
    font-size: 18px;
}
.container {
    background-color: white;
    border: 1px solid #d0d7de;
    border-radius: 4px;
    overflow: hidden;
}
table {
    width: 100%;
    border-collapse: collapse;
    table-layout: auto;
}
th {
    background-color: #f6f8fa;
    padding: 6px 8px;
    text-align: left;
    font-weight: 600;
    border-bottom: 1px solid #d0d7de;
    position: sticky;
    top: 0;
    font-size: 12px;
    white-space: nowrap;
}
td {
    padding: 4px 8px;
    border-bottom: 1px solid #d0d7de;
    vertical-align: middle;
    line-height: 1.2;
}
/* Make message column single line and flexible */
td:last-child {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 0;
}
/* Prevent wrapping in other columns */
.sha, .date, .author {
    white-space: nowrap;
}
tr:hover {
    background-color: #f6f8fa;
}
.sha {
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    font-size: 12px;
    white-space: nowrap;
}
.sha a {
    color: #0969da;
    text-decoration: none;
}
.sha a:hover {
    text-decoration: underline;
}
.message {
    color: #24292f;
}
.pr-link {
    color: #0969da;
    text-decoration: none;
    font-weight: 500;
}
.pr-link:hover {
    text-decoration: underline;
}
.docker-images {
    margin-top: 8px;
}
details {
    margin-top: 4px;
}
summary {
    cursor: pointer;
    color: #0969da;
    font-size: 13px;
    font-weight: 500;
}
summary:hover {
    text-decoration: underline;
}
.image-list {
    margin: 8px 0;
    padding-left: 20px;
}
.image-tag {
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    font-size: 12px;
    background-color: #f6f8fa;
    padding: 2px 6px;
    border-radius: 3px;
    display: block;
    margin: 4px 0;
}
.date {
    font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace;
    color: #57606a;
    font-size: 12px;
}
.author {
    color: #24292f;
    font-size: 14px;
}
.composite-sha-link {
    color: #0969da;
    text-decoration: none;
    cursor: pointer;
    border-bottom: 1px dotted #0969da;
}
.composite-sha-link:hover {
    text-decoration: underline;
}
.status-indicator {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 6px;
    vertical-align: middle;
}
.status-success {
    background-color: #2da44e;
    box-shadow: 0 0 0 2px rgba(45, 164, 78, 0.2);
}
.status-failed {
    background-color: #d73a49;
    box-shadow: 0 0 0 2px rgba(215, 58, 73, 0.2);
}
.status-building {
    background-color: #dbab09;
    box-shadow: 0 0 0 2px rgba(219, 171, 9, 0.2);
}
.status-success-inherited {
    background-color: #a8d5ba;
    box-shadow: 0 0 0 2px rgba(45, 164, 78, 0.1);
    opacity: 0.7;
}
.status-failed-inherited {
    background-color: #f5a3ab;
    box-shadow: 0 0 0 2px rgba(215, 58, 73, 0.1);
    opacity: 0.7;
}
.status-building-inherited {
    background-color: #f0d97d;
    box-shadow: 0 0 0 2px rgba(219, 171, 9, 0.1);
    opacity: 0.7;
}
.status-unknown {
    background-color: transparent;
    border: 2px solid #8c959f;
}
</style>
<script>
function toggleDockerImages(event, linkElement) {
    event.preventDefault();
    // Find the current row
    var currentRow = linkElement.closest('tr');
    // Find the next row (which should be the docker-images-row)
    var dockerRow = currentRow.nextElementSibling;

    if (dockerRow && dockerRow.classList.contains('docker-images-row')) {
        // Toggle visibility
        if (dockerRow.style.display === 'none') {
            dockerRow.style.display = 'table-row';
            linkElement.textContent = '‚ñº';  // Point down when expanded
        } else {
            dockerRow.style.display = 'none';
            linkElement.textContent = '‚ñ∂';  // Point right when collapsed
        }
    }
}

function toggleBuildHistory(event, shaShort) {
    event.preventDefault();
    event.stopPropagation();

    var historyDiv = document.getElementById('build-history-' + shaShort);

    // Close all other build history dropdowns
    var allHistories = document.querySelectorAll('[id^="build-history-"]');
    allHistories.forEach(function(div) {
        if (div.id !== 'build-history-' + shaShort) {
            div.style.display = 'none';
        }
    });

    // Toggle this one
    if (historyDiv.style.display === 'none' || historyDiv.style.display === '') {
        historyDiv.style.display = 'block';
    } else {
        historyDiv.style.display = 'none';
    }
}

// Close build history dropdown when clicking outside
document.addEventListener('click', function(event) {
    if (!event.target.closest('[onclick^="toggleBuildHistory"]') &&
        !event.target.closest('[id^="build-history-"]')) {
        var allHistories = document.querySelectorAll('[id^="build-history-"]');
        allHistories.forEach(function(div) {
            div.style.display = 'none';
        });
    }
});

function copyToClipboard(text, button) {
    // Fallback for non-HTTPS contexts (file:// protocol)
    var textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        var successful = document.execCommand('copy');
        document.body.removeChild(textArea);

        if (successful) {
            var originalHTML = button.innerHTML;
            button.innerHTML = '<svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block;"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg><span style="margin-left: 6px;">Copied!</span>';
            setTimeout(function() {
                button.innerHTML = originalHTML;
            }, 2000);
        } else {
            alert('Failed to copy text');
        }
    } catch (err) {
        document.body.removeChild(textArea);
        alert('Failed to copy: ' + err);
    }
}

function copyFromClipboardAttr(button) {
    var text = button.getAttribute('data-clipboard-text');

    if (!text) {
        alert('No text found in data-clipboard-text attribute');
        return;
    }

    // Fallback for non-HTTPS contexts (file:// protocol)
    var textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        var successful = document.execCommand('copy');
        document.body.removeChild(textArea);

        if (successful) {
            var originalHTML = button.innerHTML;
            button.innerHTML = '<svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block;"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg><span style="margin-left: 6px;">Copied!</span>';
            setTimeout(function() {
                button.innerHTML = originalHTML;
            }, 2000);
        } else {
            alert('Failed to copy text');
        }
    } catch (err) {
        document.body.removeChild(textArea);
        alert('Failed to copy: ' + err);
    }
}
</script>
</head>
<body>

<div class="header">
<h1>Dynamo Commit History</h1>
<p style="margin: 5px 0 0 0; opacity: 0.9;">Recent commits with Composite Docker SHAs (CDS) and Docker images &nbsp;&nbsp;|&nbsp;&nbsp; <span style="opacity: 0.77; font-size: 12px;">Page generated: {{ generated_time }} <span id="page-age" style="color: #ffa657;"></span></span></p>
</div>

<!-- Key/Help Section -->
<div class="container" style="margin-bottom: 20px; padding: 12px; background-color: #f6f8fa;">
<details>
<summary style="cursor: pointer; font-weight: 600; font-size: 14px; color: #24292f; user-select: none;">
Legend & Help
</summary>
<div style="margin-top: 12px; font-size: 13px; line-height: 1.6;">
<div style="margin-bottom: 12px;">
<div style="font-weight: 600; margin-bottom: 6px; color: #24292f;">Icons & Links:</div>
<ul style="margin: 4px 0; padding-left: 20px;">
<li><strong>Local Build Status Indicators</strong> - Circle appears in Composite Docker SHA column (left of CDS)
<ul style="margin: 2px 0; padding-left: 20px; font-size: 12px;">
<li><span class="status-indicator status-success" style="display: inline-block; vertical-align: middle;"></span> Green - All builds/compile/sanity passed</li>
<li><span class="status-indicator status-failed" style="display: inline-block; vertical-align: middle;"></span> Red - Some builds/compile/sanity failed</li>
<li><span class="status-indicator status-building" style="display: inline-block; vertical-align: middle;"></span> Yellow - Build in progress</li>
<li><span class="status-indicator status-unknown" style="display: inline-block; vertical-align: middle;"></span> Gray - No build status available</li>
<li><span class="status-indicator status-success-inherited" style="display: inline-block; vertical-align: middle;"></span> Hollow - Inherited status (no direct build for this commit)</li>
</ul>
</li>
<li><strong>CDS:xxxxxx</strong> - Composite Docker SHA (appears in Composite Docker SHA column, click to view build logs)</li>
<li><strong>üê≥</strong> - Search GitLab Docker registry (appears in Status column)</li>
<li><strong style="padding: 2px 4px; border-radius: 3px; font-size: 11px;">GHA</strong> - View GitHub Actions logs (appears in Status column, badge color indicates status: green=passed, red=failed, yellow=in progress, gray=no checks)</li>
<li><strong>ü¶ä</strong> - View commit in GitLab (appears in Status column with CI pipeline info)</li>
<li><strong>‚ñ∂</strong> - Expand to see Docker images and commit details</li>
</ul>
</div>
<div style="margin-bottom: 12px;">
<div style="font-weight: 600; margin-bottom: 6px; color: #24292f;">GitHub Actions Summary:</div>
<div style="display: flex; align-items: center; gap: 20px;">
<svg width="100" height="100" viewBox="0 0 100 100" style="transform: rotate(-90deg);">
{%- set total = gha_success_count + gha_failed_count + gha_in_progress_count + gha_other_count -%}
{%- if total > 0 -%}
{%- set success_pct = gha_success_count / total -%}
{%- set failed_pct = gha_failed_count / total -%}
{%- set progress_pct = gha_in_progress_count / total -%}
{%- set other_pct = gha_other_count / total -%}
{%- set radius = 15.915494309 -%}
{%- set circumference = 100 -%}
{# Success segment (green) #}
{%- set success_dash = success_pct * circumference -%}
<circle cx="50" cy="50" r="{{ radius }}" fill="none" stroke="#2da44e" stroke-width="12" stroke-dasharray="{{ success_dash }} {{ circumference }}" stroke-dashoffset="0"></circle>
{# Failed segment (red) #}
{%- set failed_dash = failed_pct * circumference -%}
{%- set failed_offset = -(success_dash) -%}
<circle cx="50" cy="50" r="{{ radius }}" fill="none" stroke="#d73a49" stroke-width="12" stroke-dasharray="{{ failed_dash }} {{ circumference }}" stroke-dashoffset="{{ failed_offset }}"></circle>
{# In progress segment (yellow) #}
{%- set progress_dash = progress_pct * circumference -%}
{%- set progress_offset = -(success_dash + failed_dash) -%}
<circle cx="50" cy="50" r="{{ radius }}" fill="none" stroke="#dbab09" stroke-width="12" stroke-dasharray="{{ progress_dash }} {{ circumference }}" stroke-dashoffset="{{ progress_offset }}"></circle>
{# Other segment (gray) #}
{%- set other_dash = other_pct * circumference -%}
{%- set other_offset = -(success_dash + failed_dash + progress_dash) -%}
<circle cx="50" cy="50" r="{{ radius }}" fill="none" stroke="#8c959f" stroke-width="12" stroke-dasharray="{{ other_dash }} {{ circumference }}" stroke-dashoffset="{{ other_offset }}"></circle>
{# Center text showing total #}
<text x="50" y="50" text-anchor="middle" dy="0.35em" font-size="20" font-weight="600" fill="#24292f" transform="rotate(90 50 50)">{{ total }}</text>
{%- endif -%}
</svg>
<ul style="margin: 4px 0; padding-left: 0; list-style: none;">
<li><span style="color: #2da44e; font-weight: 600;">{{ gha_success_count }} ‚úì</span> - All checks passed ({{ "%.1f"|format((gha_success_count / commit_count * 100) if commit_count > 0 else 0) }}%)</li>
<li><span style="color: #d73a49; font-weight: 600;">{{ gha_failed_count }} ‚úó</span> - Some checks failed ({{ "%.1f"|format((gha_failed_count / commit_count * 100) if commit_count > 0 else 0) }}%)</li>
<li><span style="color: #dbab09; font-weight: 600;">{{ gha_in_progress_count }} ‚è≥</span> - Checks in progress ({{ "%.1f"|format((gha_in_progress_count / commit_count * 100) if commit_count > 0 else 0) }}%)</li>
<li><span style="color: #8c959f; font-weight: 600;">{{ gha_other_count }} ‚óã</span> - Cancelled/No checks ({{ "%.1f"|format((gha_other_count / commit_count * 100) if commit_count > 0 else 0) }}%)</li>
</ul>
</div>
</div>
<div style="margin-bottom: 12px;">
<div style="font-weight: 600; margin-bottom: 6px; color: #24292f;">CI Status Format:</div>
<ul style="margin: 4px 0; padding-left: 20px;">
<li><span style="color: #2da44e;">16‚úì</span> - 16 jobs succeeded</li>
<li><span style="color: #d73a49;">3‚úó</span> - 3 jobs failed</li>
<li><span style="color: #dbab09;">2‚è≥</span> - 2 jobs running</li>
<li><span style="color: #8c959f;">1‚è∏</span> - 1 job pending</li>
</ul>
</div>
<div>
<div style="font-weight: 600; margin-bottom: 6px; color: #24292f;">Composite Docker SHA (CDS):</div>
<p style="margin: 4px 0; color: #57606a;">Commits with the same CDS share identical <code>container/</code> directory contents. These commits can use the same Docker images.</p>
</div>
</div>
</details>
</div>

<script>
// Calculate and display page age
(function() {
    // Parse the generated time string more reliably
    const timeStr = '{{ generated_time }}';
    // Replace PST/PDT with timezone offset
    const timeStrFixed = timeStr.replace(' PST', '-08:00').replace(' PDT', '-07:00');
    const generatedTime = new Date(timeStrFixed);

    function updatePageAge() {
        const now = new Date();
        const ageMs = now - generatedTime;

        // Check if date parsed correctly
        if (isNaN(generatedTime.getTime())) {
            document.getElementById('page-age').textContent = '(invalid date)';
            return;
        }

        // Calculate time components
        const seconds = Math.floor(ageMs / 1000);
        const minutes = Math.floor(seconds / 60);
        const hours = Math.floor(minutes / 60);
        const days = Math.floor(hours / 24);

        let ageText = '';
        if (days > 0) {
            ageText = `(${days} day${days > 1 ? 's' : ''} ${hours % 24} hour${(hours % 24) !== 1 ? 's' : ''} old)`;
        } else if (hours > 0) {
            ageText = `(${hours} hour${hours > 1 ? 's' : ''} ${minutes % 60} min old)`;
        } else if (minutes > 0) {
            ageText = `(${minutes} minute${minutes > 1 ? 's' : ''} old)`;
        } else {
            ageText = `(${seconds} second${seconds !== 1 ? 's' : ''} old)`;
        }

        document.getElementById('page-age').textContent = ageText;
    }

    // Update immediately and then every 3 seconds
    updatePageAge();
    setInterval(updatePageAge, 3000);
})();
</script>

<div class="container">
<table>
<thead>
<tr>
<th>Commit SHA</th>
<th>Composite üê≥ SHA</th>
<th>GH Status</th>
<th>GL Status</th>
<th>Date/Time (PST)</th>
<th>Author</th>
<th style="width: 100%;">Message</th>
</tr>
</thead>
<tbody>

{% for commit in commits %}
{%- set sha_short = commit.sha_short -%}
{%- set sha_full = commit.sha_full -%}
{%- set composite_sha = commit.composite_sha -%}
{%- set date_str = commit.date -%}
{%- set author = commit.author -%}
{%- set message = commit.message -%}
{%- set commit_link = "https://github.com/ai-dynamo/dynamo/commit/" ~ sha_full -%}
{%- set gitlab_commit_link = "https://gitlab-master.nvidia.com/dl/ai-dynamo/dynamo/-/commit/" ~ sha_full -%}
{%- set has_docker_images = sha_short in docker_images and docker_images[sha_short] -%}
{%- set has_gitlab = sha_full in gitlab_images and gitlab_images[sha_full] -%}
{%- set composite_bg_color = commit.composite_bg_color -%}
{%- set pipeline = gitlab_pipelines.get(sha_full) -%}

<tr>
<td class="sha">
<a href="{{ commit_link }}" target="_blank">{{ sha_short }}</a>
</td>
<td class="sha">
{%- set log_paths_list = log_paths.get(sha_short, []) -%}
{%- set status_info = build_status.get(sha_short, {}) -%}
{%- set status = status_info.get('status', 'unknown') -%}
{%- set inherited = status_info.get('inherited', False) -%}
{# Local build status indicator before CDS #}
{%- if status == 'success' -%}
<span class="status-indicator status-success{%- if inherited -%}-inherited{%- endif -%}" title="{%- if inherited -%}Inherited: {%- endif -%}All builds passed"></span>
{%- elif status == 'failed' -%}
<span class="status-indicator status-failed{%- if inherited -%}-inherited{%- endif -%}" title="{%- if inherited -%}Inherited: {%- endif -%}Some builds failed"></span>
{%- elif status == 'building' -%}
<span class="status-indicator status-building{%- if inherited -%}-inherited{%- endif -%}" title="{%- if inherited -%}Inherited: {%- endif -%}Build in progress"></span>
{%- elif status == 'unknown' -%}
<span class="status-indicator status-unknown" title="No build status available"></span>
{%- endif -%}
{%- if log_paths_list -%}
{# Most recent build (last in list) #}
{%- set latest_date, latest_path = log_paths_list[-1] -%}
<span style="background-color: {{ composite_bg_color }}; padding: 2px 6px; border-radius: 3px; margin-left: 4px;"><a href="{{ latest_path }}" target="_blank" style="color: #0969da; text-decoration: none;" title="View build logs ({{ latest_date }})">CDS:{{ composite_sha[:6] }}</a></span>{# Show history icon if multiple builds exist #}{%- if log_paths_list|length > 1 -%}<a href="#" onclick="toggleBuildHistory(event, '{{ sha_short }}'); return false;" style="text-decoration: none; margin-left: 2px; font-size: 11px; color: #656d76;" title="Show build history ({{ log_paths_list|length }} builds)">üìã</a><div id="build-history-{{ sha_short }}" style="display: none; position: absolute; background: #fff; border: 1px solid #d0d7de; border-radius: 6px; padding: 8px; margin-top: 4px; z-index: 1000; box-shadow: 0 8px 24px rgba(140, 149, 159, 0.2);"><div style="font-weight: 600; font-size: 12px; margin-bottom: 6px; color: #24292f;">Build History</div>{%- for date, path in log_paths_list|reverse -%}<div style="padding: 4px 0;"><a href="{{ path }}" target="_blank" style="color: #0969da; text-decoration: none; font-size: 12px;">{{ date }}</a>{%- if loop.first -%} <span style="color: #656d76; font-size: 11px;">(latest)</span>{%- endif -%}</div>{%- endfor -%}</div>{%- endif -%}{%- if has_docker_images or has_gitlab -%}<a href="#" class="composite-sha-link" onclick="toggleDockerImages(event, this); return false;" style="text-decoration: none; margin-left: 4px;" title="Show Docker images">‚ñ∂</a>{%- endif -%}
{%- else -%}
<span style="background-color: {{ composite_bg_color }}; padding: 2px 6px; border-radius: 3px; margin-left: 4px;">CDS:{{ composite_sha[:6] }}</span>{%- if has_docker_images or has_gitlab -%}<a href="#" class="composite-sha-link" onclick="toggleDockerImages(event, this); return false;" style="text-decoration: none; margin-left: 4px;" title="Show Docker images">‚ñ∂</a>{%- endif -%}
{%- endif -%}
</td>
<td class="sha">
{# GitHub Actions status for GHA badge color #}
{%- set gha_status = github_actions_status.get(sha_full) -%}
{%- if gha_status and gha_status.conclusion == 'success' -%}
{%- set gha_color = '#2da44e' -%}
{%- set gha_title = 'GitHub Actions: All checks passed' -%}
{%- elif gha_status and gha_status.conclusion == 'failure' -%}
{%- set gha_color = '#d73a49' -%}
{%- set gha_title = 'GitHub Actions: Some checks failed' -%}
{%- elif gha_status and gha_status.status == 'in_progress' -%}
{%- set gha_color = '#dbab09' -%}
{%- set gha_title = 'GitHub Actions: Checks in progress' -%}
{%- elif gha_status and gha_status.conclusion == 'cancelled' -%}
{%- set gha_color = '#8c959f' -%}
{%- set gha_title = 'GitHub Actions: Checks cancelled' -%}
{%- else -%}
{%- set gha_color = '#8c959f' -%}
{%- set gha_title = 'GitHub Actions: No checks' -%}
{%- endif -%}
{# GitHub section #}
<a href="https://github.com/ai-dynamo/dynamo/commit/{{ sha_full }}/checks" target="_blank" style="text-decoration: none; font-weight: 600; font-size: 11px; padding: 2px 4px; background-color: {{ gha_color }}; color: white; border-radius: 3px;" title="{{ gha_title }}">GHA</a>
{# Per-commit GHA checks donut chart #}
{%- set commit_stats = gha_per_commit_stats.get(sha_full, {'success': 0, 'failure': 0, 'in_progress': 0, 'other': 0, 'total': 0}) -%}
{%- if commit_stats.total > 0 -%}
<svg width="24" height="24" viewBox="0 0 100 100" style="transform: rotate(-90deg); vertical-align: middle; margin-left: 4px;" aria-label="GitHub Actions: {{ commit_stats.success }}‚úì {{ commit_stats.failure }}‚úó {{ commit_stats.in_progress }}‚è≥ {{ commit_stats.other }}‚óã" title="{{ commit_stats.success }}‚úì {{ commit_stats.failure }}‚úó {{ commit_stats.in_progress }}‚è≥ {{ commit_stats.other }}‚óã ({{ commit_stats.total }} checks)">
{%- set success_pct = commit_stats.success / commit_stats.total -%}
{%- set failed_pct = commit_stats.failure / commit_stats.total -%}
{%- set progress_pct = commit_stats.in_progress / commit_stats.total -%}
{%- set other_pct = commit_stats.other / commit_stats.total -%}
{%- set radius = 15.915494309 -%}
{%- set circumference = 100 -%}
{# Success segment (green) #}
{%- set success_dash = success_pct * circumference -%}
<circle cx="50" cy="50" r="{{ radius }}" fill="none" stroke="#2da44e" stroke-width="28" stroke-dasharray="{{ success_dash }} {{ circumference }}" stroke-dashoffset="0"></circle>
{# Failed segment (red) #}
{%- set failed_dash = failed_pct * circumference -%}
{%- set failed_offset = -(success_dash) -%}
<circle cx="50" cy="50" r="{{ radius }}" fill="none" stroke="#d73a49" stroke-width="28" stroke-dasharray="{{ failed_dash }} {{ circumference }}" stroke-dashoffset="{{ failed_offset }}"></circle>
{# In progress segment (yellow) #}
{%- set progress_dash = progress_pct * circumference -%}
{%- set progress_offset = -(success_dash + failed_dash) -%}
<circle cx="50" cy="50" r="{{ radius }}" fill="none" stroke="#dbab09" stroke-width="28" stroke-dasharray="{{ progress_dash }} {{ circumference }}" stroke-dashoffset="{{ progress_offset }}"></circle>
{# Other segment (gray) #}
{%- set other_dash = other_pct * circumference -%}
{%- set other_offset = -(success_dash + failed_dash + progress_dash) -%}
<circle cx="50" cy="50" r="{{ radius }}" fill="none" stroke="#8c959f" stroke-width="28" stroke-dasharray="{{ other_dash }} {{ circumference }}" stroke-dashoffset="{{ other_offset }}"></circle>
{# Center text showing total count #}
<text x="50" y="50" text-anchor="middle" dy="0.35em" font-size="32" font-weight="600" fill="#24292f" transform="rotate(90 50 50)">{{ commit_stats.total }}</text>
</svg>
{%- endif -%}
</td>
<td class="sha">
{# GitLab section #}
<a href="https://gitlab-master.nvidia.com/dl/ai-dynamo/dynamo/container_registry/85325?orderBy=PUBLISHED_AT&sort=desc&search%5B%5D={{ sha_full }}" target="_blank" style="color: #2496ed; text-decoration: none; font-weight: 600;" title="Search GitLab Docker registry for this SHA">üê≥</a>
{%- if pipeline -%}
<a href="https://gitlab-master.nvidia.com/dl/ai-dynamo/dynamo/-/commit/{{ sha_full }}" target="_blank" style="margin-left: 4px; color: #fc6d26; text-decoration: none; font-weight: 600;" title="View commit in GitLab">ü¶ä</a>
{%- set job_counts = pipeline_job_counts.get(pipeline.id) -%}
{%- if job_counts -%}
<a href="{{ pipeline.web_url }}" target="_blank" style="margin-left: 4px; text-decoration: none; font-weight: 600; font-size: 11px;" title="Click to view pipeline">
{%- if job_counts.success > 0 -%}<span style="color: #2da44e;">{{ job_counts.success }}‚úì</span>{%- endif -%}
{%- if job_counts.failed > 0 -%}{%- if job_counts.success > 0 %} {% endif -%}<span style="color: #d73a49;">{{ job_counts.failed }}‚úó</span>{%- endif -%}
{%- if job_counts.running > 0 -%}{%- if job_counts.success > 0 or job_counts.failed > 0 %} {% endif -%}<span style="color: #dbab09;">{{ job_counts.running }}‚è≥</span>{%- endif -%}
{%- if job_counts.pending > 0 -%}{%- if job_counts.success > 0 or job_counts.failed > 0 or job_counts.running > 0 %} {% endif -%}<span style="color: #8c959f;">{{ job_counts.pending }}‚è∏</span>{%- endif -%}
</a>
{%- endif -%}
{%- endif -%}
</td>
<td class="date">{{ date_str }}</td>
<td class="author">{{ author }}</td>
<td>
<div class="message">{{ message | safe }}</div>
</td>
</tr>

{# Docker images row if any exist for this SHA #}
{% if has_docker_images or has_gitlab %}
{%- set images = docker_images.get(sha_short, []) -%}
{%- set full_msg = commit.full_message -%}
{%- set files_changed = commit.files_changed -%}
{%- set insertions = commit.insertions -%}
{%- set deletions = commit.deletions -%}
{%- set changed_files = commit.changed_files -%}
{%- set gitlab_imgs = gitlab_images.get(sha_full, []) -%}

<tr class="docker-images-row" style="display: none;">
<td colspan="7" style="padding: 0; background-color: #f6f8fa;">
<div style="padding: 8px 12px; border-top: 1px solid #d0d7de;">
<!-- Commit Details Section -->
<div style="margin-bottom: 12px; padding: 8px; background-color: white; border: 1px solid #d0d7de; border-radius: 4px;">
<div style="font-weight: 600; margin-bottom: 6px; font-size: 13px;">Commit Message:</div>
<div style="font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; font-size: 12px; color: #24292f; white-space: pre-wrap; margin-bottom: 8px;">{{ full_msg | e }}</div>
<div style="font-size: 12px; color: #57606a; margin-top: 6px;">
<span style="color: #1a7f37; font-weight: 500;">+{{ insertions }}</span>
<span style="color: #cf222e; font-weight: 500;">-{{ deletions }}</span>
<span style="margin-left: 8px;">{{ files_changed }} file(s) changed</span>
</div>
<details style="margin-top: 8px;">
<summary style="cursor: pointer; color: #0969da; font-size: 12px;">Show changed files ({{ changed_files|length }})</summary>
<div style="margin-top: 4px; font-family: 'SFMono-Regular', Consolas, 'Liberation Mono', Menlo, monospace; font-size: 11px;">
{% for file in changed_files %}
<div style="padding: 2px 0;">{{ file }}</div>
{% endfor %}
</div>
</details>
</div>

{# GitLab Container Registry Section #}
{% if gitlab_imgs %}
<div style="margin-bottom: 12px; padding: 8px; background-color: white; border: 1px solid #d0d7de; border-radius: 4px;">
<div style="font-weight: 600; margin-bottom: 4px; font-size: 13px;">GitLab Container Registry (Runtime Images): <a href="https://gitlab-master.nvidia.com/dl/ai-dynamo/dynamo/container_registry/{{ gitlab_imgs[0].registry_id }}" target="_blank" style="color: #fc6d26; text-decoration: none; font-weight: 600; font-size: 12px;" title="View all images in GitLab Container Registry">ü¶ä View Registry</a></div>
<table style="width: 100%; border: none; background-color: white; border-collapse: collapse;">
<thead>
<tr>
<th style="width: 35%; padding: 3px 6px; border: none;">Image Name:Tag</th>
<th style="width: 10%; padding: 3px 6px; border: none;">pull runtime</th>
{# TODO: Add back "make localdev" column later #}
{# {% if gitlab_imgs|selectattr('arch', 'equalto', 'amd64')|selectattr('framework', 'in', ['trtllm', 'vllm'])|list|length > 0 %}<th style="width: 10%; padding: 3px 6px; border: none;">make localdev</th>{% endif %} #}
<th style="width: 10%; padding: 3px 6px; border: none;">Build ID</th>
<th style="width: 8%; padding: 3px 6px; border: none;">Size</th>
<th style="width: 27%; padding: 3px 6px; border: none;">Created (PDT)</th>
</tr>
</thead>
{# Macro to generate docker pull, wget Dockerfile, and build command (multi-line format with early stop on error)
   Example output:
   (BASE_IMAGE=gitlab-master.nvidia.com:5005/dl/ai-dynamo/dynamo:2f18b23ee7163df21f20e872b83ada4226fbf851-38897884-vllm-amd64 && \
   docker pull ${BASE_IMAGE} && \
   wget http://keivenc-linux/nvidia/dynamo-utils/container/Dockerfile.runtime_localdev_venv -O /tmp/Dockerfile.runtime_localdev_venv && \
   docker build -f /tmp/Dockerfile.runtime_localdev_venv --build-arg BASE_IMAGE=${BASE_IMAGE} --build-arg USER_UID=$(id -u) --build-arg USER_GID=$(id -g) -t dynamo:2f18b23e-vllm-local-dev /tmp && \
   echo 'Build SUCCESS! Run with: container/run.sh --image dynamo:2f18b23e-vllm-local-dev --mount-workspace -it ...')
   Note: sha_short is accessed from outer scope (commit loop)
   Note: sglang uses Dockerfile.runtime_localdev_system, vllm/trtllm use Dockerfile.runtime_localdev_venv
#}
{% macro docker_pull_tag_cmd(img, sha_short) -%}
{%- set local_tag = "dynamo:" ~ sha_short ~ "-" ~ img.framework ~ "-local-dev" -%}
{%- if img.framework|upper == "SGLANG" -%}
{%- set dockerfile_name = "Dockerfile.runtime_localdev_system" -%}
{%- else -%}
{%- set dockerfile_name = "Dockerfile.runtime_localdev_venv" -%}
{%- endif -%}
{%- set dockerfile_url = "http://keivenc-linux/nvidia/dynamo-utils/container/" ~ dockerfile_name -%}
{%- set dockerfile_path = "/tmp/" ~ dockerfile_name -%}
(BASE_IMAGE={{ img.location }} && \
docker pull ${BASE_IMAGE} && \
wget {{ dockerfile_url }} -O {{ dockerfile_path }} && \
docker build -f {{ dockerfile_path }} --build-arg BASE_IMAGE=${BASE_IMAGE} --build-arg USER_UID=$(id -u) --build-arg USER_GID=$(id -g) -t {{ local_tag }} /tmp && \
echo 'Build SUCCESS! Run with: container/run.sh --image {{ local_tag }} --mount-workspace -it ...')
{%- endmacro %}

<tbody>
{% for img in gitlab_imgs %}
{%- set arch_label = "[x86]" if img.arch == "amd64" else "[ARM]" -%}
{%- set display_tag = arch_label ~ " " ~ img.tag -%}
{%- set image_id = img.pipeline_id[:12] if img.pipeline_id|length >= 12 else img.pipeline_id -%}
<tr>
<td style="font-family: monospace; font-size: 11px; padding: 2px 6px; border: none; max-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="{{ img.tag }}
Pipeline: {{ img.pipeline_id }}
Framework: {{ img.framework }}">{{ display_tag }}</td>
<td style="font-size: 11px; padding: 2px 6px; border: none; white-space: nowrap;"><button data-clipboard-text="docker pull {{ img.location }}" onclick="copyFromClipboardAttr(this)" style="padding: 4px 6px; font-size: 11px; background-color: transparent; color: #57606a; border: 1px solid #d0d7de; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; vertical-align: middle;" title="Click to copy docker pull command for runtime image" onmouseover="this.style.backgroundColor='#f3f4f6'; this.style.borderColor='#8c959f';" onmouseout="this.style.backgroundColor='transparent'; this.style.borderColor='#d0d7de';"><svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block;"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg></button><span style="margin-left: 6px;">copy command</span></td>
{# TODO: Add back "make localdev" column later #}
{# {% if gitlab_imgs|selectattr('arch', 'equalto', 'amd64')|selectattr('framework', 'in', ['trtllm', 'vllm'])|list|length > 0 %}<td style="font-size: 11px; padding: 2px 6px; border: none; white-space: nowrap;">{% if img.arch == "amd64" and (img.framework|upper == "TRTLLM" or img.framework|upper == "VLLM") %}<button data-clipboard-text="{{ docker_pull_tag_cmd(img, sha_short) }}" onclick="copyFromClipboardAttr(this)" style="padding: 4px 6px; font-size: 11px; background-color: transparent; color: #57606a; border: 1px solid #d0d7de; border-radius: 6px; cursor: pointer; display: inline-flex; align-items: center; vertical-align: middle;" title="Click to copy command for creating local-dev image: Pulls the runtime image, downloads Dockerfile, builds a local-dev container with your UID/GID, and shows how to run it" onmouseover="this.style.backgroundColor='#f3f4f6'; this.style.borderColor='#8c959f';" onmouseout="this.style.backgroundColor='transparent'; this.style.borderColor='#d0d7de';"><svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="display: inline-block;"><path d="M0 6.75C0 5.784.784 5 1.75 5h1.5a.75.75 0 0 1 0 1.5h-1.5a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-1.5a.75.75 0 0 1 1.5 0v1.5A1.75 1.75 0 0 1 9.25 16h-7.5A1.75 1.75 0 0 1 0 14.25Z"></path><path d="M5 1.75C5 .784 5.784 0 6.75 0h7.5C15.216 0 16 .784 16 1.75v7.5A1.75 1.75 0 0 1 14.25 11h-7.5A1.75 1.75 0 0 1 5 9.25Zm1.75-.25a.25.25 0 0 0-.25.25v7.5c0 .138.112.25.25.25h7.5a.25.25 0 0 0 .25-.25v-7.5a.25.25 0 0 0-.25-.25Z"></path></svg></button><span style="margin-left: 6px;">copy command</span>{% endif %}</td>{% endif %} #}
<td style="font-family: monospace; font-size: 11px; padding: 2px 6px; border: none;"><a href="https://gitlab-master.nvidia.com/dl/ai-dynamo/dynamo/-/pipelines/{{ img.pipeline_id }}" target="_blank" style="color: #0969da;" title="View pipeline {{ img.pipeline_id }}">{{ image_id }}</a></td>
<td style="font-size: 11px; padding: 2px 6px; border: none;">{{ img.size_display }}</td>
<td style="font-size: 11px; padding: 2px 6px; border: none;">{{ img.created_display }}</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% endif %}

<!-- Docker Images Section -->
{% if images %}
<div style="margin-bottom: 12px; padding: 8px; background-color: white; border: 1px solid #d0d7de; border-radius: 4px;">
<div style="font-weight: 600; margin-bottom: 4px; font-size: 13px;">Local Docker Images:</div>
<table style="width: 100%; border: none; background-color: white; border-collapse: collapse;">
<thead>
<tr>
<th style="width: 50%; padding: 3px 6px; border: none;">Image Name:Tag</th>
<th style="width: 15%; padding: 3px 6px; border: none;">Image ID</th>
<th style="width: 10%; padding: 3px 6px; border: none;">Size</th>
<th style="width: 25%; padding: 3px 6px; border: none;">Created (PDT)</th>
</tr>
</thead>
<tbody>
{% for image in images | sort(attribute='tag') %}
<tr>
<td style="font-family: monospace; font-size: 11px; padding: 2px 6px; border: none;">{{ image.tag }}</td>
<td style="font-family: monospace; font-size: 11px; padding: 2px 6px; border: none;">{{ image.id }}</td>
<td style="font-size: 11px; padding: 2px 6px; border: none;">{{ image.size }}</td>
<td style="font-size: 11px; padding: 2px 6px; border: none;">{{ image.created }}</td>
</tr>
{% endfor %}
</tbody>
</table>
</div>
{% endif %}

</div>
</td>
</tr>
{% endif %}

{% endfor %}

</tbody>
</table>
</div>

</body>
</html>

